<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    <title>Yosys Open SYnthesis Suite &#8212; Yosys  documentation</title>

    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/material-icons.css" type="text/css" />
    <link rel="stylesheet" href="_static/notosanscjkjp.css" type="text/css" />
    <link rel="stylesheet" href="_static/roboto.css" type="text/css" />
    <link rel="stylesheet" href="_static/material-design-lite-1.3.0/material.deep_purple-purple.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx_symbiflow_theme.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/sphinx_symbiflow_theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer"><header class="mdl-layout__header mdl-layout__header--waterfall ">
    <div class="mdl-layout__header-row">
        
        <nav class="mdl-navigation breadcrumb">
            <a class="mdl-navigation__link is-active">Yosys Open SYnthesis Suite</a>
        </nav>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
        
<form class="form-inline pull-sm-right" action="search.html" method="get">
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right">
        <label id="quick-search-icon" class="mdl-button mdl-js-button mdl-button--icon"  for="waterfall-exp">
            <i class="material-icons">search</i>
        </label>
        <div class="mdl-textfield__expandable-holder">
          <input class="mdl-textfield__input" type="text" name="q"  id="waterfall-exp" placeholder="Search" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </div>
      </div>
      <div class="mdl-tooltip" data-mdl-for="quick-search-icon">
      Quick search
      </div>
</form>
        
<a id="button-show-source"
    class="mdl-button mdl-js-button mdl-button--icon"
    href="_sources/presentation.rst.txt" rel="nofollow">
<i class="material-icons">code</i>
</a>
<div class="mdl-tooltip" data-mdl-for="button-show-source">
Show Source
</div>
        </nav>
    </div>
    <div class="mdl-layout__header-row header-links">
      <div class="mdl-layout-spacer"></div>
      <nav class="mdl-navigation">
          <a  class="mdl-navigation__link" href="index.html">
                  <i class="material-icons navigation-link-icon">home</i>
                  Home
              </a>
          
              <a  class="mdl-navigation__link" href="https://github.com/YosysHQ/yosys">
                  <i class="material-icons navigation-link-icon">link</i>
                  GitHub
              </a>
      
          <a  class="mdl-navigation__link" href="https://symbiflow.github.io/">
            <i class="material-icons navigation-link-icon">web</i>
            SymbiFlow Website
          </a>
          <a  class="mdl-navigation__link" href="https://symbiflow.readthedocs.io/en/latest/">
            <i class="material-icons navigation-link-icon">library_books</i>
            SymbiFlow Docs
          </a></nav>
    </div>
</header><header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="index.html">
              <span class="title-text">
                  Yosys
              </span>
          </a>
      </span>
    
<div class="globaltoc">
  <span class="mdl-layout-title toc">Table Of Contents</span>
  
  
      
      <nav class="mdl-navigation">
          <ul>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Basics.html">Basic Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Approach.html">Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Overview.html">Implementation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_CellLib.html">Internal Cell Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Prog.html">Programming Yosys Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Verilog.html">The Verilog and AST Frontends</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Optimize.html">Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Techmap.html">Technology Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Eval.html">Evaluation, Conclusion, Future Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Auxlibs.html">Auxiliary Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Auxprogs.html">Auxiliary Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_TextRtlil.html">RTLIL Text Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Appnotes.html">Application Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_StateOfTheArt.html">Evaluation of other OSS Verilog Synthesis Tools</a></li>
</ul>

      </nav>
  
  </div>

</header>
        <main class="mdl-layout__content" tabIndex="0">
<header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="index.html">
              <span class="title-text">
                  Yosys
              </span>
          </a>
      </span>
    
<div class="globaltoc">
  <span class="mdl-layout-title toc">Table Of Contents</span>
  
  
      
      <nav class="mdl-navigation">
          <ul>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Basics.html">Basic Principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Approach.html">Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Overview.html">Implementation Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_CellLib.html">Internal Cell Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Prog.html">Programming Yosys Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Verilog.html">The Verilog and AST Frontends</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Optimize.html">Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Techmap.html">Technology Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Eval.html">Evaluation, Conclusion, Future Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Auxlibs.html">Auxiliary Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Auxprogs.html">Auxiliary Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_TextRtlil.html">RTLIL Text Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_Appnotes.html">Application Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHAPTER_StateOfTheArt.html">Evaluation of other OSS Verilog Synthesis Tools</a></li>
</ul>

      </nav>
  
  </div>

</header>

    <div class="document">
        <div class="page-content">
        
  <div class="section" id="yosys-open-synthesis-suite">
<h1>Yosys Open SYnthesis Suite<a class="headerlink" href="#yosys-open-synthesis-suite" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Clifford Wolf</p>
</dd>
</dl>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<div class="frame docutils container">
<p>Abstract Yosys is the first full-featured open source software for
Verilog HDL synthesis. It supports most of Verilog-2005 and is well
tested with real-world designs from the ASIC and FPGA world.</p>
<p>Learn how to use Yosys to create your own custom synthesis flows and
discover why open source HDL synthesis is important for researchers,
hobbyists, educators and engineers alike.</p>
<p>This presentation covers basic concepts of Yosys, writing synthesis
scripts for a wide range of applications, creating Yosys scripts for
various non-synthesis applications (such as formal equivalence
checking) and writing extensions to Yosys using the C++ API.</p>
</div>
</div>
<div class="section" id="about-me">
<h2>About me<a class="headerlink" href="#about-me" title="Permalink to this headline">¶</a></h2>
<div class="frame docutils container">
<p>About me Hi! I’m Clifford Wolf.</p>
<p>I like writing open source software. For example:</p>
<ul class="simple">
<li><p>Yosys</p></li>
<li><p>OpenSCAD (now maintained by Marius Kintel)</p></li>
<li><p>SPL (a not very popular scripting language)</p></li>
<li><p>EmbedVM (a very simple compiler+vm for 8 bit micros)</p></li>
<li><p>Lib(X)SVF (a library to play SVF/XSVF files over JTAG)</p></li>
<li><p>ROCK Linux (discontinued since 2010)</p></li>
</ul>
</div>
</div>
<div class="section" id="outline">
<h2>Outline<a class="headerlink" href="#outline" title="Permalink to this headline">¶</a></h2>
<div class="frame docutils container">
<p>Outline Yosys is an Open Source Verilog synthesis tool, and more.</p>
<p>Outline of this presentation:</p>
<ul class="simple">
<li><p>Introduction to the field and Yosys</p></li>
<li><p>Yosys by example: synthesis</p></li>
<li><p>Yosys by example: advanced synthesis</p></li>
<li><p>Yosys by example: beyond synthesis</p></li>
<li><p>Writing Yosys extensions in C++</p></li>
</ul>
</div>
</div>
<div class="section" id="introduction-to-yosys">
<h2>Introduction to Yosys<a class="headerlink" href="#introduction-to-yosys" title="Permalink to this headline">¶</a></h2>
<div class="section" id="representations-of-digital-circuits">
<h3>Representations of (digital) Circuits<a class="headerlink" href="#representations-of-digital-circuits" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Graphical</p>
<ul>
<li><p>Schematic Diagram</p></li>
<li><p>Physical Layout</p></li>
</ul>
</li>
<li><p>Non-graphical</p>
<ul>
<li><p>Netlists</p></li>
<li><p>Hardware Description Languages (HDLs)</p></li>
</ul>
</li>
</ul>
<div class="block docutils container">
<p>Definition:</p>
</div>
</div>
</div>
<div class="section" id="levels-of-abstraction-for-digital-circuits">
<h3>Levels of Abstraction for Digital Circuits<a class="headerlink" href="#levels-of-abstraction-for-digital-circuits" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>System Level</p></li>
<li><p>High Level</p></li>
<li><p>Behavioral Level</p></li>
<li><p>Register-Transfer Level (RTL)</p></li>
<li><p>Logical Gate Level</p></li>
<li><p>Physical Gate Level</p></li>
<li><p>Switch Level</p></li>
</ul>
<div class="block docutils container">
<p>Definition:</p>
</div>
</div>
</div>
<div class="section" id="digital-circuit-synthesis">
<h3>Digital Circuit Synthesis<a class="headerlink" href="#digital-circuit-synthesis" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Synthesis Tools (such as Yosys) can transform HDL code to circuits:</p>
</div>
</div>
<div class="section" id="what-yosys-can-and-cant-do">
<h3>What Yosys can and can’t do<a class="headerlink" href="#what-yosys-can-and-cant-do" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Things Yosys can do:</p>
<ul class="simple">
<li><p>Read and process (most of) modern Verilog-2005 code.</p></li>
<li><p>Perform all kinds of operations on netlist (RTL, Logic, Gate).</p></li>
<li><p>Perform logic optimizations and gate mapping with ABC <a class="footnote-reference brackets" href="#id11" id="id1">1</a>.</p></li>
</ul>
<p>Things Yosys can’t do:</p>
<ul class="simple">
<li><p>Process high-level languages such as C/C++/SystemC.</p></li>
<li><p>Create physical layouts (place&amp;route).</p></li>
</ul>
<p>A typical flow combines Yosys with with a low-level implementation
tool, such as Qflow <a class="footnote-reference brackets" href="#id12" id="id2">2</a> for ASIC designs.</p>
</div>
</div>
<div class="section" id="yosys-data-and-control-flow">
<h3>Yosys Data- and Control-Flow<a class="headerlink" href="#yosys-data-and-control-flow" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>A (usually short) synthesis script controls Yosys.</p>
<p>This scripts contain three types of commands:</p>
<ul class="simple">
<li><p><strong>Frontends</strong>, that read input files (usually Verilog).</p></li>
<li><p><strong>Passes</strong>, that perform transformations on the design in memory.</p></li>
<li><p><strong>Backends</strong>, that write the design in memory to a file (various
formats are available: Verilog, BLIF, EDIF, SPICE, BTOR, …).</p></li>
</ul>
</div>
</div>
<div class="section" id="program-components-and-data-formats">
<h3>Program Components and Data Formats<a class="headerlink" href="#program-components-and-data-formats" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
</div>
</div>
<div class="section" id="example-project">
<h3>Example Project<a class="headerlink" href="#example-project" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The following slides cover an example project. This project contains
three files:</p>
<ul class="simple">
<li><p>A simple ASIC synthesis script</p></li>
<li><p>A digital design written in Verilog</p></li>
<li><p>A simple CMOS cell library</p></li>
</ul>
<div class="line-block">
<div class="line">Direct link to the files:</div>
<div class="line"><a class="reference external" href="https://github.com/cliffordwolf/yosys/tree/master/manual/PRESENTATION_Intro">https://github.com/cliffordwolf/yosys/tree/master/manual/PRESENTATION_Intro</a></div>
</div>
</div>
<div class="frame docutils container">
<p>– Verilog Source: <code class="docutils literal notranslate"><span class="pre">counter.v</span></code></p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">counter</span> <span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rst</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

  <span class="k">input</span> <span class="n">clk</span><span class="p">,</span> <span class="n">rst</span><span class="p">,</span> <span class="n">en</span><span class="p">;</span>
  <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">count</span><span class="p">;</span>

  <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">rst</span><span class="p">)</span>
                  <span class="n">count</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mi">&#39;d0</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span>
                  <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="o">+</span> <span class="mh">2</span><span class="mi">&#39;d1</span><span class="p">;</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>– Cell Library: <code class="docutils literal notranslate"><span class="pre">mycells.lib</span></code></p>
<div class="columns docutils container">
<div class="highlight-liberty notranslate"><div class="highlight"><pre><span></span>library(demo) {
  cell(BUF) {
    area: 6;
    pin(A) { direction: input; }
    pin(Y) { direction: output;
              function: &quot;A&quot;; }
  }
  cell(NOT) {
    area: 3;
    pin(A) { direction: input; }
    pin(Y) { direction: output;
              function: &quot;A&#39;&quot;; }
  }
  cell(NAND) {
    area: 4;
    pin(A) { direction: input; }
    pin(B) { direction: input; }
    pin(Y) { direction: output;
             function: &quot;(A*B)&#39;&quot;; }
  }
</pre></div>
</div>
<div class="highlight-liberty notranslate"><div class="highlight"><pre><span></span>  cell(NOR) {
    area: 4;
    pin(A) { direction: input; }
    pin(B) { direction: input; }
    pin(Y) { direction: output;
             function: &quot;(A+B)&#39;&quot;; }
  }
  cell(DFF) {
    area: 18;
    ff(IQ, IQN) { clocked_on: C;
                  next_state: D; }
    pin(C) { direction: input;
                 clock: true; }
    pin(D) { direction: input; }
    pin(Q) { direction: output;
              function: &quot;IQ&quot;; }
  }
}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="running-the-synthesis-script">
<h3>Running the Synthesis Script<a class="headerlink" href="#running-the-synthesis-script" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>– Step 1/4</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">read_verilog</span> <span class="n">counter</span><span class="o">.</span><span class="n">v</span>
<span class="n">hierarchy</span> <span class="o">-</span><span class="n">check</span> <span class="o">-</span><span class="n">top</span> <span class="n">counter</span>
</pre></div>
</div>
<img alt="image" src="PRESENTATION_Intro/counter_00.pdf" />
</div>
<div class="frame docutils container">
<p>– Step 2/4</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span><span class="p">;</span> <span class="n">opt</span><span class="p">;</span> <span class="n">fsm</span><span class="p">;</span> <span class="n">opt</span><span class="p">;</span> <span class="n">memory</span><span class="p">;</span> <span class="n">opt</span>
</pre></div>
</div>
<img alt="image" src="PRESENTATION_Intro/counter_01.pdf" />
</div>
<div class="frame docutils container">
<p>– Step 3/4</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">techmap</span><span class="p">;</span> <span class="n">opt</span>
</pre></div>
</div>
<img alt="image" src="PRESENTATION_Intro/counter_02.pdf" />
</div>
<div class="frame docutils container">
<p>– Step 4/4</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dfflibmap</span> <span class="o">-</span><span class="n">liberty</span> <span class="n">mycells</span><span class="o">.</span><span class="n">lib</span>
<span class="n">abc</span> <span class="o">-</span><span class="n">liberty</span> <span class="n">mycells</span><span class="o">.</span><span class="n">lib</span>
<span class="n">clean</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="PRESENTATION_Intro/counter_03.pdf"><img alt="image" src="PRESENTATION_Intro/counter_03.pdf" style="width: 10cm;" /></a>
</div>
</div>
<div class="section" id="the-synth-command">
<h3>The synth command<a class="headerlink" href="#the-synth-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Yosys contains a default (recommended example) synthesis script in
form of the <code class="docutils literal notranslate"><span class="pre">synth</span></code> command. The following commands are executed by
this synthesis command:</p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>begin:
    hierarchy -check [-top &lt;top&gt;]

coarse:
    proc
    opt
    wreduce
    alumacc
    share
    opt
    fsm
    opt -fast
    memory -nomap
    opt_clean
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>fine:
    opt -fast -full
    memory_map
    opt -full
    techmap
    opt -fast

abc:
    abc -fast
    opt -fast
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="yosys-commands">
<h3>Yosys Commands<a class="headerlink" href="#yosys-commands" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>1/3 (excerpt) Command reference:</p>
<ul class="simple">
<li><p>Use “<code class="docutils literal notranslate"><span class="pre">help</span></code>” for a command list and “<code class="docutils literal notranslate"><span class="pre">help</span> <span class="pre">command</span></code>” for
details.</p></li>
<li><p>Or run “<code class="docutils literal notranslate"><span class="pre">yosys</span> <span class="pre">-H</span></code>” or “<code class="docutils literal notranslate"><span class="pre">yosys</span> <span class="pre">-h</span> <span class="pre">command</span></code>”.</p></li>
<li><p>Or go to <a class="reference external" href="http://www.clifford.at/yosys/documentation.html">http://www.clifford.at/yosys/documentation.html</a>.</p></li>
</ul>
<p>Commands for design navigation and investigation:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>cd                   # a shortcut for &#39;select -module &lt;name&gt;&#39;
    ls                   # list modules or objects in modules
    dump                 # print parts of the design in RTLIL format
    show                 # generate schematics using graphviz
    select               # modify and view the list of selected objects
</pre></div>
</div>
<p>Commands for executing scripts or entering interactive mode:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>shell                # enter interactive command mode
    history              # show last interactive commands
    script               # execute commands from script file
    tcl                  # execute a TCL script file
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>2/3 (excerpt) Commands for reading and elaborating the design:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_rtlil           # read modules from RTLIL file
    read_verilog         # read modules from Verilog file
    hierarchy            # check, expand and clean up design hierarchy
</pre></div>
</div>
<p>Commands for high-level synthesis:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>proc                 # translate processes to netlists
    fsm                  # extract and optimize finite state machines
    memory               # translate memories to basic cells
    opt                  # perform simple optimizations
</pre></div>
</div>
<p>Commands for technology mapping:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>techmap              # generic technology mapper
    abc                  # use ABC for technology mapping
    dfflibmap            # technology mapping of flip-flops
    hilomap              # technology mapping of constant hi- and/or lo-drivers
    iopadmap             # technology mapping of i/o pads (or buffers)
    flatten              # flatten design
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>3/3 (excerpt) Commands for writing the results:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>write_blif           # write design to BLIF file
    write_btor           # write design to BTOR file
    write_edif           # write design to EDIF netlist file
    write_rtlil          # write design to RTLIL file
    write_spice          # write design to SPICE netlist file
    write_verilog        # write design to Verilog file
</pre></div>
</div>
<p>Script-Commands for standard synthesis tasks:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>synth                # generic synthesis script
    synth_xilinx         # synthesis for Xilinx FPGAs
</pre></div>
</div>
<p>Commands for model checking:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>sat                  # solve a SAT problem in the circuit
    miter                # automatically create a miter circuit
    scc                  # detect strongly connected components (logic loops)
</pre></div>
</div>
<p>… and many many more.</p>
</div>
</div>
<div class="section" id="more-verilog-examples">
<h3>More Verilog Examples<a class="headerlink" href="#more-verilog-examples" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>1/3</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">detectprime</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">output</span> <span class="n">y</span><span class="p">;</span>

    <span class="k">integer</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">lut</span><span class="p">;</span>

    <span class="k">initial</span> <span class="k">begin</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
            <span class="n">lut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mh">1</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">2</span><span class="p">;</span> <span class="n">j</span><span class="o">*</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">j</span> <span class="o">==</span> <span class="mh">0</span><span class="p">)</span>
                    <span class="n">lut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">lut</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>2/3</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">carryadd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="k">parameter</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mh">8</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">output</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">;</span>

    <span class="k">genvar</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">generate</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WIDTH</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span> <span class="k">begin</span><span class="o">:</span><span class="n">STAGE</span>
            <span class="kt">wire</span> <span class="n">IN1</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">IN2</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">wire</span> <span class="n">C</span><span class="p">,</span> <span class="n">Y</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0</span><span class="p">)</span>
                <span class="k">assign</span> <span class="n">C</span> <span class="o">=</span> <span class="n">IN1</span> <span class="o">&amp;</span> <span class="n">IN2</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">IN1</span> <span class="o">^</span> <span class="n">IN2</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="k">assign</span> <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">IN1</span> <span class="o">&amp;</span> <span class="n">IN2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">IN1</span> <span class="o">|</span> <span class="n">IN2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STAGE</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mh">1</span><span class="p">].</span><span class="n">C</span><span class="p">),</span>
                       <span class="n">Y</span> <span class="o">=</span> <span class="n">IN1</span> <span class="o">^</span> <span class="n">IN2</span> <span class="o">^</span> <span class="n">STAGE</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mh">1</span><span class="p">].</span><span class="n">C</span><span class="p">;</span>
            <span class="k">assign</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">endgenerate</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>3/3</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">cam</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">wr_enable</span><span class="p">,</span> <span class="n">wr_addr</span><span class="p">,</span> <span class="n">wr_data</span><span class="p">,</span> <span class="n">rd_data</span><span class="p">,</span> <span class="n">rd_addr</span><span class="p">,</span> <span class="n">rd_match</span><span class="p">);</span>
    <span class="k">parameter</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mh">8</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">DEPTH</span> <span class="o">=</span> <span class="mh">16</span><span class="p">;</span>
    <span class="k">localparam</span> <span class="n">ADDR_BITS</span> <span class="o">=</span> <span class="n">$clog2</span><span class="p">(</span><span class="n">DEPTH</span><span class="o">-</span><span class="mh">1</span><span class="p">);</span>

    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span> <span class="n">wr_enable</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">ADDR_BITS</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">wr_addr</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">wr_data</span><span class="p">,</span> <span class="n">rd_data</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="n">ADDR_BITS</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">rd_addr</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="n">rd_match</span><span class="p">;</span>

    <span class="k">integer</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mem</span> <span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="n">DEPTH</span><span class="o">-</span><span class="mh">1</span><span class="p">];</span>

    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">rd_addr</span> <span class="o">&lt;=</span> <span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
        <span class="n">rd_match</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEPTH</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rd_data</span><span class="p">)</span> <span class="k">begin</span>
                <span class="n">rd_addr</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">rd_match</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
            <span class="k">end</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">wr_enable</span><span class="p">)</span>
            <span class="n">mem</span><span class="p">[</span><span class="n">wr_addr</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wr_data</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="currently-unsupported-verilog-2005-language-features">
<h3>Currently unsupported Verilog-2005 language features<a class="headerlink" href="#currently-unsupported-verilog-2005-language-features" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Tri-state logic</p></li>
<li><p>The wor/wand wire types (maybe for 0.5)</p></li>
<li><p>Latched logic (is synthesized as logic with feedback loops)</p></li>
<li><p>Some non-synthesizable features that should be ignored in
synthesis are not supported by the parser and cause a parser error
(file a bug report if you encounter this problem)</p></li>
</ul>
</div>
</div>
<div class="section" id="verification-of-yosys">
<h3>Verification of Yosys<a class="headerlink" href="#verification-of-yosys" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Continuously checking the correctness of Yosys and making sure that
new features do not break old ones is a high priority in Yosys.</p>
<p>Two external test suites have been built for Yosys: VlogHammer and
yosys-bigsim (see next slides)</p>
<p>In addition to that, yosys comes with <span class="math">\approx\!200</span> test cases
used in “<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test</span></code>”.</p>
<p>A debug build of Yosys also contains a lot of asserts and checks the
integrity of the internal state after each command.</p>
</div>
<div class="frame docutils container">
<p>– VlogHammer VlogHammer is a Verilog regression test suite developed
to test the different subsystems in Yosys by comparing them to each
other and to the output created by some other tools (Xilinx Vivado,
Xilinx XST, Altera Quartus II, …).</p>
<p>Yosys Subsystems tested: Verilog frontend, const folding, const eval,
technology mapping, simulation models, SAT models.</p>
<p>Thousands of auto-generated test cases containing code such as:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">assign</span> <span class="n">y9</span> <span class="o">=</span> <span class="n">$signed</span><span class="p">(((</span><span class="o">+</span><span class="n">$signed</span><span class="p">((</span><span class="o">^</span><span class="p">(</span><span class="mh">6</span><span class="mi">&#39;d2</span> <span class="o">**</span> <span class="n">a2</span><span class="p">))))</span><span class="o">&lt;</span><span class="n">$unsigned</span><span class="p">(</span><span class="n">$unsigned</span><span class="p">(((</span><span class="o">+</span><span class="n">a3</span><span class="p">))))));</span>
<span class="k">assign</span> <span class="n">y10</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="o">+</span><span class="p">((</span><span class="o">+</span><span class="p">{</span><span class="mh">2</span><span class="p">{(</span><span class="o">~^</span><span class="n">p13</span><span class="p">)}})))</span><span class="o">^~</span><span class="p">(</span><span class="o">!</span><span class="p">{{</span><span class="n">b5</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">a0</span><span class="p">},(</span><span class="n">a1</span><span class="o">&amp;</span><span class="n">p12</span><span class="p">),(</span><span class="n">a4</span><span class="o">+</span><span class="n">a3</span><span class="p">)})));</span>
<span class="k">assign</span> <span class="n">y11</span> <span class="o">=</span> <span class="p">(</span><span class="o">~&amp;</span><span class="p">(</span><span class="o">-</span><span class="p">{(</span><span class="o">-</span><span class="mh">3</span><span class="p">&#39;</span><span class="n">sd3</span><span class="p">),(</span><span class="n">$unsigned</span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">$unsigned</span><span class="p">({</span><span class="n">p0</span><span class="p">,</span><span class="n">b4</span><span class="p">,</span><span class="n">b1</span><span class="p">}))))}));</span>
</pre></div>
</div>
<p>Some bugs in Yosys where found and fixed thanks to VlogHammer. Over
50 bugs in the other tools used as external reference where found and
reported so far.</p>
</div>
<div class="frame docutils container">
<p>– yosys-bigsim yosys-bigsim is a collection of real-world open-source
Verilog designs and test benches. yosys-bigsim compares the testbench
outputs of simulations of the original Verilog code and synthesis
results.</p>
<p>The following designs are included in yosys-bigsim (excerpt):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">openmsp430</span></code> – an MSP430 compatible 16 bit CPU</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aes_5cycle_2stage</span></code> – an AES encryption core</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">softusb_navre</span></code> – an AVR compatible 8 bit CPU</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">amber23</span></code> – an ARMv2 compatible 32 bit CPU</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lm32</span></code> – another 32 bit CPU from Lattice Semiconductor</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verilog-pong</span></code> – a hardware pong game with VGA output</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">elliptic_curve_group</span></code> – ECG point-add and point-scalar-mul core</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">reed_solomon_decoder</span></code> – a Reed-Solomon Error Correction Decoder</p></li>
</ul>
</div>
</div>
<div class="section" id="benefits-of-open-source-hdl-synthesis">
<h3>Benefits of Open Source HDL Synthesis<a class="headerlink" href="#benefits-of-open-source-hdl-synthesis" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Cost (also applies to “free as in free beer” solutions)</p></li>
<li><p>Availability and Reproducibility</p></li>
<li><p>Framework- and all-in-one-aspects</p></li>
<li><p>Educational Tool</p></li>
</ul>
<p>Yosys is open source under the ISC license.</p>
</div>
<div class="frame docutils container">
<p>– 1/3</p>
<ul>
<li><p>Cost (also applies to “free as in free beer” solutions):</p>
<p>Today the cost for a mask set in <span class="math">\unit[180]{nm}</span> technology
is far less than the cost for the design tools needed to design
the mask layouts. Open Source ASIC flows are an important enabler
for ASIC-level Open Source Hardware.</p>
</li>
<li><p>Availability and Reproducibility:</p>
<p>If you are a researcher who is publishing, you want to use tools
that everyone else can also use. Even if most universities have
access to all major commercial tools, you usually do not have easy
access to the version that was used in a research project a couple
of years ago. With Open Source tools you can even release the
source code of the tool you have used alongside your data.</p>
</li>
</ul>
</div>
<div class="frame docutils container">
<p>– 2/3</p>
<ul>
<li><p>Framework:</p>
<p>Yosys is not only a tool. It is a framework that can be used as
basis for other developments, so researchers and hackers alike do
not need to re-invent the basic functionality. Extensibility was
one of Yosys’ design goals.</p>
</li>
<li><p>All-in-one:</p>
<p>Because of the framework characteristics of Yosys, an increasing
number of features become available in one tool. Yosys not only
can be used for circuit synthesis but also for formal equivalence
checking, SAT solving, and for circuit analysis, to name just a
few other application domains. With proprietary software one needs
to learn a new tool for each of these applications.</p>
</li>
</ul>
</div>
<div class="frame docutils container">
<p>– 3/3</p>
<ul>
<li><p>Educational Tool:</p>
<p>Proprietary synthesis tools are at times very secretive about
their inner workings. They often are “black boxes”. Yosys is very
open about its internals and it is easy to observe the different
steps of synthesis.</p>
</li>
</ul>
<div class="block docutils container">
<p>Yosys is licensed under the ISC license: Permission to use, copy,
modify, and/or distribute this software for any purpose with or
without fee is hereby granted, provided that the above copyright
notice and this permission notice appear in all copies.</p>
</div>
</div>
</div>
<div class="section" id="typical-applications-for-yosys">
<h3>Typical Applications for Yosys<a class="headerlink" href="#typical-applications-for-yosys" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Synthesis of final production designs</p></li>
<li><p>Pre-production synthesis (trial runs before investing in other
tools)</p></li>
<li><p>Conversion of full-featured Verilog to simple Verilog</p></li>
<li><p>Conversion of Verilog to other formats (BLIF, BTOR, etc)</p></li>
<li><p>Demonstrating synthesis algorithms (e.g. for educational purposes)</p></li>
<li><p>Framework for experimenting with new algorithms</p></li>
<li><p>Framework for building custom flows <a class="footnote-reference brackets" href="#id13" id="id3">3</a></p></li>
</ul>
</div>
</div>
<div class="section" id="projects-that-i-know-of-using-yosys">
<h3>Projects (that I know of) using Yosys<a class="headerlink" href="#projects-that-i-know-of-using-yosys" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>– (1/2)</p>
<ul>
<li><div class="line-block">
<div class="line">Ongoing PhD project on coarse grain synthesis</div>
<div class="line">Johann Glaser and Clifford Wolf. Methodology and Example-Driven
Interconnect Synthesis for Designing Heterogeneous Coarse-Grain
Reconfigurable Architectures. In Jan Haase, editor, <em>Models,
Methods, and Tools for Complex Chip Design. Lecture Notes in
Electrical Engineering. Volume 265, 2014, pp 201-221. Springer,
2013.</em></div>
</div>
</li>
<li><p>I know several people that use Yosys simply as Verilog frontend
for other flows (using either the BLIF and BTOR backends).</p></li>
<li><p>I know some analog chip designers that use Yosys for small digital
control logic because it is simpler than setting up a commercial
flow.</p></li>
</ul>
</div>
<div class="frame docutils container">
<p>– (2/2)</p>
<ul>
<li><p>Efabless</p>
<ul>
<li><p>Not much information on the website (<a class="reference external" href="http://efabless.com">http://efabless.com</a>) yet.</p></li>
<li><p>Very cheap 180nm prototyping process (partnering with various
fabs)</p></li>
<li><p>A semiconductor company, NOT an EDA company</p></li>
<li><p>Web-based design environment</p></li>
<li><p>HDL Synthesis using Yosys</p></li>
<li><p>Custom place&amp;route tool</p></li>
<li><div class="line-block">
<div class="line">efabless is building an Open Source IC as reference design.</div>
<div class="line">(to be announced soon: <a class="reference external" href="http://www.openic.io">http://www.openic.io</a>)</div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="supported-platforms">
<h3>Supported Platforms<a class="headerlink" href="#supported-platforms" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Main development OS: Kubuntu 14.04</p></li>
<li><p>There is a PPA for ubuntu (not maintained by me)</p></li>
<li><p>Any current Debian-based system should work out of the box</p></li>
<li><p>When building on other Linux distributions:</p>
<ul>
<li><p>Needs compiler with some C++11 support</p></li>
<li><p>See README file for build instructions</p></li>
<li><p>Post to the subreddit if you get stuck</p></li>
</ul>
</li>
<li><p>Ported to OS X (Darwin) and OpenBSD</p></li>
<li><p>Native win32 build with VisualStudio</p></li>
<li><p>Cross win32 build with MXE</p></li>
</ul>
</div>
</div>
<div class="section" id="other-open-source-tools">
<h3>Other Open Source Tools<a class="headerlink" href="#other-open-source-tools" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul>
<li><div class="line-block">
<div class="line">Icarus Verilog</div>
<div class="line">Verilog Simulation (and also a good syntax checker)</div>
<div class="line"><a class="reference external" href="http://iverilog.icarus.com/">http://iverilog.icarus.com/</a></div>
</div>
</li>
<li><div class="line-block">
<div class="line">Qflow (incl. TimberWolf, qrouter and Magic)</div>
<div class="line">A complete ASIC synthesis flow, using Yosys and ABC</div>
<div class="line"><a class="reference external" href="http://opencircuitdesign.com/qflow/">http://opencircuitdesign.com/qflow/</a></div>
</div>
</li>
<li><div class="line-block">
<div class="line">ABC</div>
<div class="line">Logic optimization, technology mapping, and more</div>
<div class="line"><a class="reference external" href="http://www.eecs.berkeley.edu/~alanmi/abc/">http://www.eecs.berkeley.edu/~alanmi/abc/</a></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="yosys-needs-you">
<h3>Yosys needs you<a class="headerlink" href="#yosys-needs-you" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>…as an active user:</p>
<ul class="simple">
<li><p>Use Yosys for on your own projects</p></li>
<li></li>
<li><p>Join the discussion on the Subreddit</p></li>
<li><p>Report bugs and send in feature requests</p></li>
</ul>
<p>…as a developer:</p>
<ul class="simple">
<li><p>Use Yosys as environment for your (research) work</p></li>
<li></li>
<li><p>Fork the project on github or create loadable plugins</p></li>
<li><p>We need a VHDL frontend or a good VHDL-to-Verilog converter</p></li>
</ul>
</div>
</div>
<div class="section" id="documentation-downloads-contacts">
<h3>Documentation, Downloads, Contacts<a class="headerlink" href="#documentation-downloads-contacts" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul>
<li><div class="line-block">
<div class="line">Website:</div>
<div class="line"><a class="reference external" href="http://www.clifford.at/yosys/">http://www.clifford.at/yosys/</a></div>
</div>
</li>
<li><div class="line-block">
<div class="line">Manual, Command Reference, Application Notes:</div>
<div class="line"><a class="reference external" href="http://www.clifford.at/yosys/documentation.html">http://www.clifford.at/yosys/documentation.html</a></div>
</div>
</li>
<li><div class="line-block">
<div class="line">Instead of a mailing list we have a SubReddit:</div>
<div class="line"><a class="reference external" href="http://www.reddit.com/r/yosys/">http://www.reddit.com/r/yosys/</a></div>
</div>
</li>
<li><div class="line-block">
<div class="line">Direct link to the source code:</div>
<div class="line"><a class="reference external" href="https://github.com/cliffordwolf/yosys">https://github.com/cliffordwolf/yosys</a></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Yosys is a powerful tool and framework for Verilog synthesis.</p></li>
<li><p>It uses a command-based interface and can be controlled by
scripts.</p></li>
<li><p>By combining existing commands and implementing new commands Yosys
can be used in a wide range of application far beyond simple
synthesis.</p></li>
</ul>
<div class="center docutils container">
<p>Questions?</p>
</div>
<div class="center docutils container">
<p><a class="reference external" href="http://www.clifford.at/yosys/">http://www.clifford.at/yosys/</a></p>
</div>
</div>
</div>
</div>
<div class="section" id="yosys-by-example-synthesis">
<h2>Yosys by example – Synthesis<a class="headerlink" href="#yosys-by-example-synthesis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="typical-phases-of-a-synthesis-flow">
<h3>Typical Phases of a Synthesis Flow<a class="headerlink" href="#typical-phases-of-a-synthesis-flow" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Reading and elaborating the design</p></li>
<li><p>Higher-level synthesis and optimization</p>
<ul>
<li><p>Converting <code class="docutils literal notranslate"><span class="pre">always</span></code>-blocks to logic and registers</p></li>
<li><p>Perform coarse-grain optimizations (resource sharing, const
folding, …)</p></li>
<li><p>Handling of memories and other coarse-grain blocks</p></li>
<li><p>Extracting and optimizing finite state machines</p></li>
</ul>
</li>
<li><p>Convert remaining logic to bit-level logic functions</p></li>
<li><p>Perform optimizations on bit-level logic functions</p></li>
<li><p>Map bit-level logic gates and registers to cell library</p></li>
<li><p>Write results to output file</p></li>
</ul>
</div>
</div>
<div class="section" id="reading-the-design">
<h3>Reading the design<a class="headerlink" href="#reading-the-design" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog file1.v
read_verilog -I include_dir -D enable_foo -D WIDTH=12 file2.v
read_verilog -lib cell_library.v

verilog_defaults -add -I include_dir
read_verilog file3.v
read_verilog file4.v
verilog_defaults -clear

verilog_defaults -push
verilog_defaults -add -I include_dir
read_verilog file5.v
read_verilog file6.v
verilog_defaults -pop
</pre></div>
</div>
</div>
</div>
<div class="section" id="design-elaboration">
<h3>Design elaboration<a class="headerlink" href="#design-elaboration" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>During design elaboration Yosys figures out how the modules are
hierarchically connected. It also re-runs the AST parts of the
Verilog frontend to create all needed variations of parametric
modules.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span># simplest form. at least this version should be used after reading all input files
#
hierarchy

# recommended form. fails if parts of the design hierarchy are missing, removes
# everything that is unreachable from the top module, and marks the top module.
#
hierarchy -check -top top_module
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-proc-command">
<h3>The <code class="docutils literal notranslate"><span class="pre">proc</span></code> command<a class="headerlink" href="#the-proc-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The Verilog frontend converts <code class="docutils literal notranslate"><span class="pre">always</span></code>-blocks to RTL netlists for
the expressions and “processes” for the control- and memory elements.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">proc</span></code> command transforms this “processes” to netlists of RTL
multiplexer and register cells.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">proc</span></code> command is actually a macro-command that calls the
following other commands:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>proc_clean      # remove empty branches and processes
proc_rmdead     # remove unreachable branches
proc_init       # special handling of &quot;initial&quot; blocks
proc_arst       # identify modeling of async resets
proc_mux        # convert decision trees to multiplexer networks
proc_dff        # extract registers from processes
proc_clean      # if all went fine, this should remove all the processes
</pre></div>
</div>
<p>Many commands can not operate on modules with “processes” in them.
Usually a call to <code class="docutils literal notranslate"><span class="pre">proc</span></code> is the first command in the actual
synthesis procedure after design elaboration.</p>
</div>
<div class="frame docutils container">
<p>– Example 1/3</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">D</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="k">output</span> <span class="kt">reg</span> <span class="n">Q</span><span class="p">);</span>
    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">C</span><span class="p">,</span> <span class="k">posedge</span> <span class="n">R</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span>
           <span class="n">Q</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
       <span class="k">else</span>
           <span class="n">Q</span> <span class="o">&lt;=</span> <span class="n">D</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog proc_01.v
hierarchy -check -top test
proc;;
</pre></div>
</div>
</div>
<a class="reference internal image-reference" href="PRESENTATION_ExSyn/proc_01.pdf"><img alt="image" src="PRESENTATION_ExSyn/proc_01.pdf" style="width: 8cm;" /></a>
</div>
<div class="frame docutils container">
<p>– Example 2/3 to 0cm<img alt="image" src="PRESENTATION_ExSyn/proc_02.pdf" /></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">D</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">RV</span><span class="p">,</span>
            <span class="k">output</span> <span class="kt">reg</span> <span class="n">Q</span><span class="p">);</span>
    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">C</span><span class="p">,</span> <span class="k">posedge</span> <span class="n">R</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span>
           <span class="n">Q</span> <span class="o">&lt;=</span> <span class="n">RV</span><span class="p">;</span>
       <span class="k">else</span>
           <span class="n">Q</span> <span class="o">&lt;=</span> <span class="n">D</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog proc_02.v
hierarchy -check -top test
proc;;
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 3/3 to 0cm<img alt="image1" src="PRESENTATION_ExSyn/proc_03.pdf" /></p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog proc_03.v
hierarchy -check -top test
proc;;
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span>
            <span class="k">output</span> <span class="kt">reg</span> <span class="n">Y</span><span class="p">);</span>
    <span class="k">always</span> <span class="p">@</span><span class="o">*</span> <span class="k">begin</span>
       <span class="n">Y</span> <span class="o">&lt;=</span> <span class="n">A</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">B</span><span class="p">)</span>
           <span class="n">Y</span> <span class="o">&lt;=</span> <span class="n">C</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">D</span><span class="p">)</span>
           <span class="n">Y</span> <span class="o">&lt;=</span> <span class="n">E</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-opt-command">
<h3>The <code class="docutils literal notranslate"><span class="pre">opt</span></code> command<a class="headerlink" href="#the-opt-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">opt</span></code> command implements a series of simple optimizations. It
also is a macro command that calls other commands:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>opt_expr                # const folding and simple expression rewriting
opt_merge -nomux        # merging identical cells

do
    opt_muxtree         # remove never-active branches from multiplexer tree
    opt_reduce          # consolidate trees of boolean ops to reduce functions
    opt_merge           # merging identical cells
    opt_rmdff           # remove/simplify registers with constant inputs
    opt_clean           # remove unused objects (cells, wires) from design
    opt_expr            # const folding and simple expression rewriting
while [changed design]
</pre></div>
</div>
<p>The command <code class="docutils literal notranslate"><span class="pre">clean</span></code> can be used as alias for <code class="docutils literal notranslate"><span class="pre">opt_clean</span></code>. And
<code class="docutils literal notranslate"><span class="pre">;;</span></code> can be used as shortcut for <code class="docutils literal notranslate"><span class="pre">clean</span></code>. For example:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>proc; opt; memory; opt_expr;; fsm;;
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 1/4 to 0cm<img alt="image2" src="PRESENTATION_ExSyn/opt_01.pdf" /></p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog opt_01.v
hierarchy -check -top test
opt
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="k">output</span> <span class="n">Y</span><span class="p">);</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">?</span> <span class="n">A</span> <span class="o">?</span> <span class="n">B</span> <span class="o">:</span> <span class="mh">1</span><span class="mb">&#39;b1</span> <span class="o">:</span> <span class="n">B</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 2/4 to 0cm<img alt="image3" src="PRESENTATION_ExSyn/opt_02.pdf" /></p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog opt_02.v
hierarchy -check -top test
opt
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">A</span><span class="p">,</span> <span class="k">output</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">);</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">==</span> <span class="n">A</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">A</span> <span class="o">!=</span> <span class="n">A</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 3/4 to 0cm<img alt="image4" src="PRESENTATION_ExSyn/opt_03.pdf" /></p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog opt_03.v
hierarchy -check -top test
opt
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span>  <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span>
            <span class="k">output</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">);</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">A</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 4/4 to 0cm<a class="reference internal" href="PRESENTATION_ExSyn/opt_04.pdf"><img alt="image5" src="PRESENTATION_ExSyn/opt_04.pdf" style="width: 6cm;" /></a></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">CLK</span><span class="p">,</span> <span class="n">ARST</span><span class="p">,</span>
            <span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">,</span> <span class="n">Q3</span><span class="p">);</span>

<span class="kt">wire</span> <span class="n">NO_CLK</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">CLK</span><span class="p">,</span> <span class="k">posedge</span> <span class="n">ARST</span><span class="p">)</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">ARST</span><span class="p">)</span>
               <span class="n">Q1</span> <span class="o">&lt;=</span> <span class="mh">42</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">NO_CLK</span><span class="p">,</span> <span class="k">posedge</span> <span class="n">ARST</span><span class="p">)</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">ARST</span><span class="p">)</span>
               <span class="n">Q2</span> <span class="o">&lt;=</span> <span class="mh">42</span><span class="p">;</span>
       <span class="k">else</span>
               <span class="n">Q2</span> <span class="o">&lt;=</span> <span class="mh">23</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">CLK</span><span class="p">)</span>
       <span class="n">Q3</span> <span class="o">&lt;=</span> <span class="mh">42</span><span class="p">;</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog opt_04.v
hierarchy -check -top test
proc; opt
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="when-to-use-opt-or-clean">
<h3>When to use <code class="docutils literal notranslate"><span class="pre">opt</span></code> or <code class="docutils literal notranslate"><span class="pre">clean</span></code><a class="headerlink" href="#when-to-use-opt-or-clean" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Usually it does not hurt to call <code class="docutils literal notranslate"><span class="pre">opt</span></code> after each regular command
in the synthesis script. But it increases the synthesis time, so it
is favourable to only call <code class="docutils literal notranslate"><span class="pre">opt</span></code> when an improvement can be
achieved.</p>
<p>The designs in <code class="docutils literal notranslate"><span class="pre">yosys-bigsim</span></code> are a good playground for
experimenting with the effects of calling <code class="docutils literal notranslate"><span class="pre">opt</span></code> in various places
of the flow.</p>
<p>It generally is a good idea to call <code class="docutils literal notranslate"><span class="pre">opt</span></code> before inherently
expensive commands such as <code class="docutils literal notranslate"><span class="pre">sat</span></code> or <code class="docutils literal notranslate"><span class="pre">freduce</span></code>, as the possible
gain is much higher in this cases as the possible loss.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">clean</span></code> command on the other hand is very fast and many
commands leave a mess (dangling signal wires, etc). For example, most
commands do not remove any wires or cells. They just change the
connections and depend on a later call to clean to get rid of the now
unused objects. So the occasional <code class="docutils literal notranslate"><span class="pre">;;</span></code> is a good idea in every
synthesis script.</p>
</div>
</div>
<div class="section" id="the-memory-command">
<h3>The <code class="docutils literal notranslate"><span class="pre">memory</span></code> command<a class="headerlink" href="#the-memory-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>In the RTL netlist, memory reads and writes are individual cells.
This makes consolidating the number of ports for a memory easier. The
<code class="docutils literal notranslate"><span class="pre">memory</span></code> transforms memories to an implementation. Per default that
is logic for address decoders and registers. It also is a macro
command that calls other commands:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span># this merges registers into the memory read- and write cells.
memory_dff

# this collects all read and write cells for a memory and transforms them
# into one multi-port memory cell.
memory_collect

# this takes the multi-port memory cell and transforms it to address decoder
# logic and registers. This step is skipped if &quot;memory&quot; is called with -nomap.
memory_map
</pre></div>
</div>
<p>Usually it is preferred to use architecture-specific RAM resources
for memory. For example:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>memory -nomap; techmap -map my_memory_map.v; memory_map
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 1/2 to 0cm<img alt="image6" src="PRESENTATION_ExSyn/memory_01.pdf" /></p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog memory_01.v
hierarchy -check -top test
proc;; memory; opt
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span>      <span class="n">CLK</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">,</span>
            <span class="k">input</span>      <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">DIN</span><span class="p">,</span>
           <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">DOUT</span><span class="p">);</span>
    <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mem</span> <span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">1</span><span class="p">];</span>
    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">CLK</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">mem</span><span class="p">[</span><span class="n">ADDR</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">DIN</span><span class="p">;</span>
       <span class="n">DOUT</span> <span class="o">&lt;=</span> <span class="n">mem</span><span class="p">[</span><span class="n">ADDR</span><span class="p">];</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 2/2 to 0cm<a class="reference internal" href="PRESENTATION_ExSyn/memory_02.pdf"><img alt="image7" src="PRESENTATION_ExSyn/memory_02.pdf" style="width: 7.5cm;" /></a></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span>
    <span class="k">input</span>             <span class="n">WR1_CLK</span><span class="p">,</span>  <span class="n">WR2_CLK</span><span class="p">,</span>
    <span class="k">input</span>             <span class="n">WR1_WEN</span><span class="p">,</span>  <span class="n">WR2_WEN</span><span class="p">,</span>
    <span class="k">input</span>      <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">WR1_ADDR</span><span class="p">,</span> <span class="n">WR2_ADDR</span><span class="p">,</span>
    <span class="k">input</span>      <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">WR1_DATA</span><span class="p">,</span> <span class="n">WR2_DATA</span><span class="p">,</span>
    <span class="k">input</span>             <span class="n">RD1_CLK</span><span class="p">,</span>  <span class="n">RD2_CLK</span><span class="p">,</span>
    <span class="k">input</span>      <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">RD1_ADDR</span><span class="p">,</span> <span class="n">RD2_ADDR</span><span class="p">,</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">RD1_DATA</span><span class="p">,</span> <span class="n">RD2_DATA</span>
<span class="p">);</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">memory</span> <span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">255</span><span class="p">];</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">WR1_CLK</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">WR1_WEN</span><span class="p">)</span>
        <span class="n">memory</span><span class="p">[</span><span class="n">WR1_ADDR</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">WR1_DATA</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">WR2_CLK</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">WR2_WEN</span><span class="p">)</span>
        <span class="n">memory</span><span class="p">[</span><span class="n">WR2_ADDR</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">WR2_DATA</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">RD1_CLK</span><span class="p">)</span>
    <span class="n">RD1_DATA</span> <span class="o">&lt;=</span> <span class="n">memory</span><span class="p">[</span><span class="n">RD1_ADDR</span><span class="p">];</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">RD2_CLK</span><span class="p">)</span>
    <span class="n">RD2_DATA</span> <span class="o">&lt;=</span> <span class="n">memory</span><span class="p">[</span><span class="n">RD2_ADDR</span><span class="p">];</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog memory_02.v
hierarchy -check -top test
proc;; memory -nomap
opt -mux_undef -mux_bool
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-fsm-command">
<h3>The <code class="docutils literal notranslate"><span class="pre">fsm</span></code> command<a class="headerlink" href="#the-fsm-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">fsm</span></code> command identifies, extracts, optimizes (re-encodes), and
re-synthesizes finite state machines. It again is a macro that calls
a series of other commands:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>fsm_detect          # unless got option -nodetect
fsm_extract

fsm_opt
clean
fsm_opt

fsm_expand          # if got option -expand
clean               # if got option -expand
fsm_opt             # if got option -expand

fsm_recode          # unless got option -norecode

fsm_info

fsm_export          # if got option -export
fsm_map             # unless got option -nomap
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>– details Some details on the most important commands from the
<code class="docutils literal notranslate"><span class="pre">fsm_</span></code> group:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fsm_detect</span></code> command identifies FSM state registers and marks
them with the <code class="docutils literal notranslate"><span class="pre">(*</span> <span class="pre">fsm_encoding</span> <span class="pre">=</span> <span class="pre">&quot;auto&quot;</span> <span class="pre">*)</span></code> attribute, if they do
not have the <code class="docutils literal notranslate"><span class="pre">fsm_encoding</span></code> set already. Mark registers with
<code class="docutils literal notranslate"><span class="pre">(*</span> <span class="pre">fsm_encoding</span> <span class="pre">=</span> <span class="pre">&quot;none&quot;</span> <span class="pre">*)</span></code> to disable FSM optimization for a
register.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">fsm_extract</span></code> command replaces the entire FSM (logic and state
registers) with a <code class="docutils literal notranslate"><span class="pre">$fsm</span></code> cell.</p>
<p>The commands <code class="docutils literal notranslate"><span class="pre">fsm_opt</span></code> and <code class="docutils literal notranslate"><span class="pre">fsm_recode</span></code> can be used to optimize
the FSM.</p>
<p>Finally the <code class="docutils literal notranslate"><span class="pre">fsm_map</span></code> command can be used to convert the
(optimized) <code class="docutils literal notranslate"><span class="pre">$fsm</span></code> cell back to logic and registers.</p>
</div>
</div>
<div class="section" id="the-techmap-command">
<h3>The <code class="docutils literal notranslate"><span class="pre">techmap</span></code> command<a class="headerlink" href="#the-techmap-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>to 0cm<a class="reference internal" href="PRESENTATION_ExSyn/techmap_01.pdf"><img alt="image8" src="PRESENTATION_ExSyn/techmap_01.pdf" style="width: 12cm;" /></a> The <code class="docutils literal notranslate"><span class="pre">techmap</span></code> command replaces cells with
implementations given as verilog source. For example implementing a
32 bit adder using 16 bit adders:</p>
<p>to 0cm</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$add</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="k">generate</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">A_WIDTH</span> <span class="o">==</span> <span class="mh">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">B_WIDTH</span> <span class="o">==</span> <span class="mh">32</span><span class="p">))</span>
    <span class="k">begin</span>
      <span class="kt">wire</span> <span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">S1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
      <span class="kt">wire</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">S2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">S1</span><span class="p">[</span><span class="mh">16</span><span class="p">];</span>
      <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">{</span><span class="n">S2</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span> <span class="n">S1</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="kt">wire</span> <span class="n">_TECHMAP_FAIL_</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">endgenerate</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<p>to 0cm</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
            <span class="k">output</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">);</span>
<span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog techmap_01.v
hierarchy -check -top test
techmap -map techmap_01_map.v;;
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>– stdcell mapping When <code class="docutils literal notranslate"><span class="pre">techmap</span></code> is used without a map file, it
uses a built-in map file to map all RTL cell types to a generic
library of built-in logic gates and registers.</p>
<div class="block docutils container">
<p>The built-in logic gate types are:
<code class="docutils literal notranslate"><span class="pre">$_NOT_</span> <span class="pre">$_AND_</span> <span class="pre">$_OR_</span> <span class="pre">$_XOR_</span> <span class="pre">$_MUX_</span></code></p>
</div>
<div class="block docutils container">
<p>The register types are:
<code class="docutils literal notranslate"><span class="pre">$_SR_NN_</span> <span class="pre">$_SR_NP_</span> <span class="pre">$_SR_PN_</span> <span class="pre">$_SR_PP_</span> <span class="pre">$_DFF_N_</span> <span class="pre">$_DFF_P_</span> <span class="pre">$_DFF_NN0_</span> <span class="pre">$_DFF_NN1_</span> <span class="pre">$_DFF_NP0_</span> <span class="pre">$_DFF_NP1_</span> <span class="pre">$_DFF_PN0_</span> <span class="pre">$_DFF_PN1_</span> <span class="pre">$_DFF_PP0_</span> <span class="pre">$_DFF_PP1_</span> <span class="pre">$_DFFSR_NNN_</span> <span class="pre">$_DFFSR_NNP_</span> <span class="pre">$_DFFSR_NPN_</span> <span class="pre">$_DFFSR_NPP_</span> <span class="pre">$_DFFSR_PNN_</span> <span class="pre">$_DFFSR_PNP_</span> <span class="pre">$_DFFSR_PPN_</span> <span class="pre">$_DFFSR_PPP_</span> <span class="pre">$_DLATCH_N_</span> <span class="pre">$_DLATCH_P_</span></code></p>
</div>
</div>
</div>
<div class="section" id="the-abc-command">
<h3>The <code class="docutils literal notranslate"><span class="pre">abc</span></code> command<a class="headerlink" href="#the-abc-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">abc</span></code> command provides an interface to ABC <a class="footnote-reference brackets" href="#id14" id="id4">4</a>, an open source
tool for low-level logic synthesis.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">abc</span></code> command processes a netlist of internal gate types and
can perform:</p>
<ul class="simple">
<li><p>logic minimization (optimization)</p></li>
<li><p>mapping of logic to standard cell library (liberty format)</p></li>
<li><p>mapping of logic to k-LUTs (for FPGA synthesis)</p></li>
</ul>
<p>Optionally <code class="docutils literal notranslate"><span class="pre">abc</span></code> can process registers from one clock domain and
perform sequential optimization (such as register balancing).</p>
<p>ABC is also controlled using scripts. An ABC script can be specified
to use more advanced ABC features. It is also possible to write the
design with <code class="docutils literal notranslate"><span class="pre">write_blif</span></code> and load the output file into ABC outside
of Yosys.</p>
</div>
<div class="frame docutils container">
<p>– Example</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">clk</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
            <span class="k">output</span> <span class="kt">reg</span> <span class="n">y</span><span class="p">);</span>

       <span class="kt">reg</span> <span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">;</span>
       <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
               <span class="n">q1</span> <span class="o">&lt;=</span> <span class="p">{</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="p">};</span>
               <span class="n">q2</span> <span class="o">&lt;=</span> <span class="n">q1</span><span class="p">;</span>
               <span class="n">y</span> <span class="o">&lt;=</span> <span class="o">^</span><span class="n">q2</span><span class="p">;</span>
       <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog abc_01.v
read_verilog -lib abc_01_cells.v
hierarchy -check -top test
proc; opt; techmap
abc -dff -liberty abc_01_cells.lib;;
</pre></div>
</div>
</div>
<img alt="image" src="PRESENTATION_ExSyn/abc_01.pdf" />
</div>
</div>
<div class="section" id="other-special-purpose-mapping-commands">
<h3>Other special-purpose mapping commands<a class="headerlink" href="#other-special-purpose-mapping-commands" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="block docutils container">
<p><code class="docutils literal notranslate"><span class="pre">dfflibmap</span></code> This command maps the internal register cell types
to the register types described in a liberty file.</p>
</div>
<div class="block docutils container">
<p><code class="docutils literal notranslate"><span class="pre">hilomap</span></code> Some architectures require special driver cells for
driving a constant hi or lo value. This command replaces simple
constants with instances of such driver cells.</p>
</div>
<div class="block docutils container">
<p><code class="docutils literal notranslate"><span class="pre">iopadmap</span></code> Top-level input/outputs must usually be implemented
using special I/O-pad cells. This command inserts this cells to
the design.</p>
</div>
</div>
</div>
<div class="section" id="example-synthesis-script">
<h3>Example Synthesis Script<a class="headerlink" href="#example-synthesis-script" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span># read and elaborate design
read_verilog cpu_top.v cpu_ctrl.v cpu_regs.v
read_verilog -D WITH_MULT cpu_alu.v
hierarchy -check -top cpu_top

# high-level synthesis
proc; opt; fsm;; memory -nomap; opt

# substitute block rams
techmap -map map_rams.v

# map remaining memories
memory_map

# low-level synthesis
techmap; opt; flatten;; abc -lut6
techmap -map map_xl_cells.v

# add clock buffers
select -set xl_clocks t:FDRE %x:+FDRE[C] t:FDRE %d
iopadmap -inpad BUFGP O:I @xl_clocks

# add io buffers
select -set xl_nonclocks w:* t:BUFGP %x:+BUFGP[I] %d
iopadmap -outpad OBUF I:O -inpad IBUF O:I @xl_nonclocks

# write synthesis results
write_edif synth.edif
</pre></div>
</div>
<div class="block docutils container">
<p>Teaser / Outlook</p>
<p>The weird <code class="docutils literal notranslate"><span class="pre">select</span></code> expressions at the end of this script are
discussed in the next part (Section 3, “Advanced Synthesis”) of
this presentation.</p>
</div>
</div>
</div>
</div>
<div class="section" id="summary-1">
<span id="id5"></span><h3>Summary<a class="headerlink" href="#summary-1" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Yosys provides commands for each phase of the synthesis.</p></li>
<li><p>Each command solves a (more or less) simple problem.</p></li>
<li><p>Complex commands are often only front-ends to simple commands.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">proc;</span> <span class="pre">opt;</span> <span class="pre">fsm;</span> <span class="pre">opt;</span> <span class="pre">memory;</span> <span class="pre">opt;</span> <span class="pre">techmap;</span> <span class="pre">opt;</span> <span class="pre">abc;;</span></code></p></li>
</ul>
<div class="center docutils container">
<p>Questions?</p>
</div>
<div class="center docutils container">
<p><a class="reference external" href="http://www.clifford.at/yosys/">http://www.clifford.at/yosys/</a></p>
</div>
</div>
</div>
</div>
<div class="section" id="yosys-by-example-advanced-synthesis">
<h2>Yosys by example – Advanced Synthesis<a class="headerlink" href="#yosys-by-example-advanced-synthesis" title="Permalink to this headline">¶</a></h2>
<div class="frame docutils container">
<p>Overview This section contains 4 subsections:</p>
<ul class="simple">
<li><p>Using selections</p></li>
<li><p>Advanced uses of techmap</p></li>
<li><p>Coarse-grain synthesis</p></li>
<li><p>Automatic design changes</p></li>
</ul>
</div>
<div class="section" id="using-selections">
<h3>Using selections<a class="headerlink" href="#using-selections" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="centering docutils container">
<p>of   1em</p>
<div class="beamercolorbox docutils container">
<p>graybox</p>
</div>
</div>
</div>
<div class="section" id="simple-selections">
<h4>Simple selections<a class="headerlink" href="#simple-selections" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Most Yosys commands make use of the “selection framework” of Yosys.
It can be used to apply commands only to part of the design. For
example:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>delete                # will delete the whole design, but

delete foobar         # will only delete the module foobar.
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">select</span></code> command can be used to create a selection for
subsequent commands. For example:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select foobar         # select the module foobar
delete                # delete selected objects
select -clear         # reset selection (select whole design)
</pre></div>
</div>
</div>
</div>
<div class="section" id="selection-by-object-name">
<h4>Selection by object name<a class="headerlink" href="#selection-by-object-name" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>The easiest way to select objects is by object name. This is usually
only done in synthesis scripts that are hand-tailored for a specific
design.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select foobar         # select module foobar
select foo*           # select all modules whose names start with foo
select foo*/bar*      # select all objects matching bar* from modules matching foo*
select */clk          # select objects named clk from all modules
</pre></div>
</div>
</div>
</div>
<div class="section" id="module-and-design-context">
<h4>Module and design context<a class="headerlink" href="#module-and-design-context" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Commands can be executed in <em>module</em> or <em>design</em> context. Until now
all commands have been executed in design context. The <code class="docutils literal notranslate"><span class="pre">cd</span></code> command
can be used to switch to module context.</p>
<p>In module context all commands only effect the active module. Objects
in the module are selected without the <code class="docutils literal notranslate"><span class="pre">&lt;module_name&gt;/</span></code> prefix. For
example:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>cd foo                # switch to module foo
delete bar            # delete object foo/bar

cd mycpu              # switch to module mycpu
dump reg_*            # print details on all objects whose names start with reg_

cd ..                 # switch back to design
</pre></div>
</div>
<p>Note: Most synthesis scripts never switch to module context. But it
is a very powerful tool for interactive design investigation.</p>
</div>
</div>
<div class="section" id="selecting-by-object-property-or-type">
<h4>Selecting by object property or type<a class="headerlink" href="#selecting-by-object-property-or-type" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Special patterns can be used to select by object property or type.
For example:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select w:reg_*        # select all wires whose names start with reg_
select a:foobar       # select all objects with the attribute foobar set
select a:foobar=42    # select all objects with the attribute foobar set to 42
select A:blabla       # select all modules with the attribute blabla set
select foo/t:$add     # select all $add cells from the module foo
</pre></div>
</div>
<p>A complete list of this pattern expressions can be found in the
command reference to the <code class="docutils literal notranslate"><span class="pre">select</span></code> command.</p>
</div>
</div>
<div class="section" id="combining-selection">
<h4>Combining selection<a class="headerlink" href="#combining-selection" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>When more than one selection expression is used in one statement,
then they are pushed on a stack. The final elements on the stack are
combined into a union:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select t:$dff r:WIDTH&gt;1     # all cells of type $dff and/or with a parameter WIDTH &gt; 1
</pre></div>
</div>
<p>Special %-commands can be used to combine the elements on the stack:</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select t:$dff r:WIDTH&gt;1 %i  # all cells of type $dff *AND* with a parameter WIDTH &gt; 1
</pre></div>
</div>
<div class="block docutils container">
<div class="line-block">
<div class="line">Examples for <code class="docutils literal notranslate"><span class="pre">%</span></code>-codes (see <code class="docutils literal notranslate"><span class="pre">help</span> <span class="pre">select</span></code> for full list)
<code class="docutils literal notranslate"><span class="pre">%u</span></code> union of top two elements on stack – pop 2, push 1</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">%d</span></code> difference of top two elements on stack – pop 2, push 1</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">%i</span></code> intersection of top two elements on stack – pop 2, push 1</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">%n</span></code> inverse of top element on stack – pop 1, push 1</div>
</div>
</div>
</div>
</div>
<div class="section" id="expanding-selections">
<h4>Expanding selections<a class="headerlink" href="#expanding-selections" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Selections of cells and wires can be expanded along connections using
<code class="docutils literal notranslate"><span class="pre">%</span></code>-codes for selecting input cones (<code class="docutils literal notranslate"><span class="pre">%ci</span></code>), output cones
(<code class="docutils literal notranslate"><span class="pre">%co</span></code>), or both (<code class="docutils literal notranslate"><span class="pre">%x</span></code>).</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span># select all wires that are inputs to $add cells
select t:$add %ci w:* %i
</pre></div>
</div>
<p>Additional constraints such as port names can be specified.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span># select all wires that connect a &quot;Q&quot; output with a &quot;D&quot; input
select c:* %co:+[Q] w:* %i c:* %ci:+[D] w:* %i %i

# select the multiplexer tree that drives the signal &#39;state&#39;
select state %ci*:+$mux,$pmux[A,B,Y]
</pre></div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">help</span> <span class="pre">select</span></code> for full documentation of this expressions.</p>
</div>
</div>
<div class="section" id="incremental-selection">
<h4>Incremental selection<a class="headerlink" href="#incremental-selection" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Sometimes a selection can most easily be described by a series of
add/delete operations. The commands <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">-add</span></code> and
<code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">-del</span></code> respectively add or remove objects from the current
selection instead of overwriting it.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select -none            # start with an empty selection
select -add reg_*       # select a bunch of objects
select -del reg_42      # but not this one
select -add state %ci   # and add mor stuff
</pre></div>
</div>
<p>Within a select expression the token <code class="docutils literal notranslate"><span class="pre">%</span></code> can be used to push the
previous selection on the stack.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select t:$add t:$sub    # select all $add and $sub cells
select % %ci % %d       # select only the input wires to those cells
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-selection-variables">
<h4>Creating selection variables<a class="headerlink" href="#creating-selection-variables" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Selections can be stored under a name with the <code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">-set</span> <span class="pre">&lt;name&gt;</span></code>
command. The stored selections can be used in later select
expressions using the syntax <code class="docutils literal notranslate"><span class="pre">&#64;&lt;name&gt;</span></code>.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>select -set cone_a state_a %ci*:-$dff  # set @cone_a to the input cone of state_a
select -set cone_b state_b %ci*:-$dff  # set @cone_b to the input cone of state_b
select @cone_a @cone_b %i              # select the objects that are in both cones
</pre></div>
</div>
<p>Remember that select expressions can also be used directly as
arguments to most commands. Some commands also except a single select
argument to some options. In those cases selection variables must be
used to capture more complex selections.</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>dump @cone_a @cone_b

select -set cone_ab @cone_a @cone_b %i
show -color red @cone_ab -color magenta @cone_a -color blue @cone_b
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>– Example</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">output</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="p">;</span>
        <span class="n">c</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="kt">wire</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">state_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">state_b</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="o">!</span><span class="n">s</span> <span class="o">?</span> <span class="n">state_a</span> <span class="o">:</span> <span class="n">state_b</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog select.v
hierarchy -check -top test
proc; opt
cd test
select -set cone_a state_a %ci*:-$dff
select -set cone_b state_b %ci*:-$dff
select -set cone_ab @cone_a @cone_b %i
show -prefix select -format pdf -notitle \
     -color red @cone_ab -color magenta @cone_a \
     -color blue @cone_b
</pre></div>
</div>
</div>
<img alt="image" src="PRESENTATION_ExAdv/select.pdf" />
</div>
</div>
</div>
<div class="section" id="advanced-uses-of-techmap">
<h3>Advanced uses of techmap<a class="headerlink" href="#advanced-uses-of-techmap" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="centering docutils container">
<p>of   1em</p>
<div class="beamercolorbox docutils container">
<p>graybox</p>
</div>
</div>
</div>
<div class="section" id="introduction-to-techmap">
<h4>Introduction to techmap<a class="headerlink" href="#introduction-to-techmap" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">techmap</span></code> command replaces cells in the design with
implementations given as Verilog code (called “map files”). It can
replace Yosys’ internal cell types (such as <code class="docutils literal notranslate"><span class="pre">$or</span></code>) as well as
user-defined cell types.</p></li>
<li><p>Verilog parameters are used extensively to customize the internal
cell types.</p></li>
<li><p>Additional special parameters are used by techmap to communicate
meta-data to the map files.</p></li>
<li><p>Special wires are used to instruct techmap how to handle a module
in the map file.</p></li>
<li><p>Generate blocks and recursion are powerful tools for writing map
files.</p></li>
</ul>
</div>
<div class="frame docutils container">
<p>– Example 1/2 To map the Verilog OR-reduction operator to 3-input OR
gates:</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$reduce_or</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

    <span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>

    <span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

    <span class="k">function</span> <span class="k">integer</span> <span class="n">min</span><span class="p">;</span>
        <span class="k">input</span> <span class="k">integer</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">begin</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">min</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">min</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">endfunction</span>

    <span class="k">genvar</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">generate</span> <span class="k">begin</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">==</span> <span class="mh">0</span><span class="p">)</span> <span class="k">begin</span>
            <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
        <span class="k">end</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span>        <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">==</span> <span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
            <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">==</span> <span class="mh">2</span><span class="p">)</span> <span class="k">begin</span>
            <span class="kt">wire</span> <span class="n">ybuf</span><span class="p">;</span>
            <span class="n">OR3X1</span> <span class="n">g</span> <span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mh">0</span><span class="p">]),</span> <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mh">1</span><span class="p">]),</span> <span class="p">.</span><span class="n">C</span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">),</span> <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">ybuf</span><span class="p">));</span>
            <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">ybuf</span><span class="p">;</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">==</span> <span class="mh">3</span><span class="p">)</span> <span class="k">begin</span>
            <span class="kt">wire</span> <span class="n">ybuf</span><span class="p">;</span>
            <span class="n">OR3X1</span> <span class="n">g</span> <span class="p">(.</span><span class="n">A</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mh">0</span><span class="p">]),</span> <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mh">1</span><span class="p">]),</span> <span class="p">.</span><span class="n">C</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mh">2</span><span class="p">]),</span> <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">ybuf</span><span class="p">));</span>
            <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">ybuf</span><span class="p">;</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">&gt;</span> <span class="mh">3</span><span class="p">)</span> <span class="k">begin</span>
            <span class="k">localparam</span> <span class="n">next_stage_sz</span> <span class="o">=</span> <span class="p">(</span><span class="n">A_WIDTH</span><span class="o">+</span><span class="mh">2</span><span class="p">)</span> <span class="o">/</span> <span class="mh">3</span><span class="p">;</span>
            <span class="kt">wire</span> <span class="p">[</span><span class="n">next_stage_sz</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">next_stage</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">next_stage_sz</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
                <span class="k">localparam</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">-</span> <span class="mh">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mh">3</span><span class="p">);</span>
                <span class="k">assign</span> <span class="n">next_stage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">|</span><span class="n">A</span><span class="p">[</span><span class="mh">3</span><span class="o">*</span><span class="n">i</span> <span class="o">+:</span> <span class="n">bits</span><span class="p">];</span>
            <span class="k">end</span>
            <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="o">|</span><span class="n">next_stage</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">end</span> <span class="k">endgenerate</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 2/2 to 0cm<a class="reference internal" href="PRESENTATION_ExAdv/red_or3x1.pdf"><img alt="image9" src="PRESENTATION_ExAdv/red_or3x1.pdf" style="width: 10cm;" /></a></p>
<div class="columns docutils container">
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>techmap -map red_or3x1_map.v;;
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">output</span> <span class="n">Y</span><span class="p">;</span>
    <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="o">|</span><span class="n">A</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="conditional-techmap">
<h4>Conditional techmap<a class="headerlink" href="#conditional-techmap" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul class="simple">
<li><p>In some cases only cells with certain properties should be
substituted.</p></li>
<li><p>The special wire <code class="docutils literal notranslate"><span class="pre">_TECHMAP_FAIL_</span></code> can be used to disable a
module in the map file for a certain set of parameters.</p></li>
<li><p>The wire <code class="docutils literal notranslate"><span class="pre">_TECHMAP_FAIL_</span></code> must be set to a constant value. If it
is non-zero then the module is disabled for this set of
parameters.</p></li>
<li><p>Example use-cases:</p>
<ul>
<li><p>coarse-grain cell types that only operate on certain bit widths</p></li>
<li><p>memory resources for different memory geometries (width, depth,
ports, etc.)</p></li>
</ul>
</li>
</ul>
</div>
<div class="frame docutils container">
<p>– Example to 0cm<a class="reference internal" href="PRESENTATION_ExAdv/sym_mul.pdf"><img alt="image10" src="PRESENTATION_ExAdv/sym_mul.pdf" style="width: 6cm;" /></a></p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$mul</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
    <span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

    <span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
    <span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

    <span class="kt">wire</span> <span class="n">_TECHMAP_FAIL_</span> <span class="o">=</span> <span class="n">A_WIDTH</span> <span class="o">!=</span> <span class="n">B_WIDTH</span> <span class="o">||</span> <span class="n">B_WIDTH</span> <span class="o">!=</span> <span class="n">Y_WIDTH</span><span class="p">;</span>

    <span class="n">MYMUL</span> <span class="p">#(</span> <span class="p">.</span><span class="n">WIDTH</span><span class="p">(</span><span class="n">Y_WIDTH</span><span class="p">)</span> <span class="p">)</span> <span class="n">g</span> <span class="p">(</span> <span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">A</span><span class="p">),</span> <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">B</span><span class="p">),</span> <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="p">);</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Y1</span><span class="p">,</span> <span class="n">Y2</span><span class="p">);</span>
    <span class="k">input</span>   <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">;</span>
    <span class="k">output</span>  <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y1</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span><span class="p">;</span>
    <span class="k">output</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y2</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">C</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog sym_mul_test.v
hierarchy -check -top test

techmap -map sym_mul_map.v;;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="scripting-in-map-modules">
<h4>Scripting in map modules<a class="headerlink" href="#scripting-in-map-modules" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul class="simple">
<li><p>The special wires <code class="docutils literal notranslate"><span class="pre">_TECHMAP_DO_</span></code> can be used to run Yosys
scripts in the context of the replacement module.</p></li>
<li><p>The wire that comes first in alphabetical oder is interpreted as
string (must be connected to constants) that is executed as
script. Then the wire is removed. Repeat.</p></li>
<li><p>You can even call techmap recursively!</p></li>
<li><p>Example use-cases:</p>
<ul>
<li><p>Using always blocks in map module: call <code class="docutils literal notranslate"><span class="pre">proc</span></code></p></li>
<li><p>Perform expensive optimizations (such as <code class="docutils literal notranslate"><span class="pre">freduce</span></code>) on cells
where this is known to work well.</p></li>
<li><p>Interacting with custom commands.</p></li>
</ul>
</li>
</ul>
<p>PROTIP: Commands such as <code class="docutils literal notranslate"><span class="pre">shell</span></code>, <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">-pause</span></code>, and <code class="docutils literal notranslate"><span class="pre">dump</span></code> can
be use in the <code class="docutils literal notranslate"><span class="pre">_TECHMAP_DO_</span></code> scripts for debugging map modules.</p>
</div>
<div class="frame docutils container">
<p>– Example to 0cm<a class="reference internal" href="PRESENTATION_ExAdv/mymul.pdf"><img alt="image11" src="PRESENTATION_ExAdv/mymul.pdf" style="width: 10cm;" /></a></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">MYMUL</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
    <span class="k">parameter</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

    <span class="kt">wire</span> <span class="p">[</span><span class="mh">1023</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">_TECHMAP_DO_</span> <span class="o">=</span> <span class="s">&quot;proc; clean&quot;</span><span class="p">;</span>

    <span class="k">integer</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">always</span> <span class="p">@</span><span class="o">*</span> <span class="k">begin</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WIDTH</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">+</span> <span class="p">(</span><span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">;</span>
    <span class="k">output</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">B</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog mymul_test.v
hierarchy -check -top test

techmap -map sym_mul_map.v \
        -map mymul_map.v;;
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>rename test test_mapped
read_verilog mymul_test.v
miter -equiv test test_mapped miter
flatten miter

sat -verify -prove trigger 0 miter
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="handling-constant-inputs">
<h4>Handling constant inputs<a class="headerlink" href="#handling-constant-inputs" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul class="simple">
<li><p>The special parameters <code class="docutils literal notranslate"><span class="pre">_TECHMAP_CONSTMSK__</span></code> and
<code class="docutils literal notranslate"><span class="pre">_TECHMAP_CONSTVAL__</span></code> can be used to handle constant input
values to cells.</p></li>
<li><p>The former contains 1-bits for all constant input bits on the
port.</p></li>
<li><p>The latter contains the constant bits or undef (x) for
non-constant bits.</p></li>
<li><p>Example use-cases:</p>
<ul>
<li><p>Converting arithmetic (for example multiply to shift)</p></li>
<li><p>Identify constant addresses or enable bits in memory
interfaces.</p></li>
</ul>
</li>
</ul>
</div>
<div class="frame docutils container">
<p>– Example to 0cm<a class="reference internal" href="PRESENTATION_ExAdv/mulshift.pdf"><img alt="image12" src="PRESENTATION_ExAdv/mulshift.pdf" style="width: 5cm;" /></a></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">MYMUL</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
    <span class="k">parameter</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

    <span class="k">parameter</span> <span class="n">_TECHMAP_CONSTVAL_A_</span> <span class="o">=</span> <span class="n">WIDTH</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">_TECHMAP_CONSTVAL_B_</span> <span class="o">=</span> <span class="n">WIDTH</span><span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>

    <span class="kt">reg</span> <span class="n">_TECHMAP_FAIL_</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="p">[</span><span class="mh">1023</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">_TECHMAP_DO_</span> <span class="o">=</span> <span class="s">&quot;proc; clean&quot;</span><span class="p">;</span>

    <span class="k">integer</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">always</span> <span class="p">@</span><span class="o">*</span> <span class="k">begin</span>
       <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WIDTH</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mh">1</span><span class="p">)</span> <span class="k">begin</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_TECHMAP_CONSTVAL_A_</span> <span class="o">===</span> <span class="n">WIDTH</span><span class="mi">&#39;d1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">begin</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
                <span class="n">Y</span> <span class="o">&lt;=</span> <span class="n">B</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
           <span class="k">end</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_TECHMAP_CONSTVAL_B_</span> <span class="o">===</span> <span class="n">WIDTH</span><span class="mi">&#39;d1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="k">begin</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
                <span class="n">Y</span> <span class="o">&lt;=</span> <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
           <span class="k">end</span>
       <span class="k">end</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">X</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="mh">8</span><span class="p">&#39;</span><span class="n">d</span> <span class="mh">6</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="mh">8</span><span class="p">&#39;</span><span class="n">d</span> <span class="mh">8</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog mulshift_test.v
hierarchy -check -top test

techmap -map sym_mul_map.v \
        -map mulshift_map.v;;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="handling-shorted-inputs">
<h4>Handling shorted inputs<a class="headerlink" href="#handling-shorted-inputs" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul class="simple">
<li><p>The special parameters <code class="docutils literal notranslate"><span class="pre">_TECHMAP_BITS_CONNMAP_</span></code> and
<code class="docutils literal notranslate"><span class="pre">_TECHMAP_CONNMAP__</span></code> can be used to handle shorted inputs.</p></li>
<li><p>Each bit of the port correlates to an <code class="docutils literal notranslate"><span class="pre">_TECHMAP_BITS_CONNMAP_</span></code>
bits wide number in <code class="docutils literal notranslate"><span class="pre">_TECHMAP_CONNMAP__</span></code>.</p></li>
<li><p>Each unique signal bit is assigned its own number. Identical
fields in the <code class="docutils literal notranslate"><span class="pre">_TECHMAP_CONNMAP__</span></code> parameters mean shorted
signal bits.</p></li>
<li><p>The numbers 0-3 are reserved for <code class="docutils literal notranslate"><span class="pre">0</span></code>, <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code>
respectively.</p></li>
<li><p>Example use-cases:</p>
<ul>
<li><p>Detecting shared clock or control signals in memory interfaces.</p></li>
<li><p>In some cases this can be used for for optimization.</p></li>
</ul>
</li>
</ul>
</div>
<div class="frame docutils container">
<p>– Example to 0cm<a class="reference internal" href="PRESENTATION_ExAdv/addshift.pdf"><img alt="image13" src="PRESENTATION_ExAdv/addshift.pdf" style="width: 5cm;" /></a></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$add</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
  <span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
  <span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
  <span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
  <span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
  <span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

  <span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
  <span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
  <span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

  <span class="k">parameter</span> <span class="n">_TECHMAP_BITS_CONNMAP_</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
  <span class="k">parameter</span> <span class="n">_TECHMAP_CONNMAP_A_</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
  <span class="k">parameter</span> <span class="n">_TECHMAP_CONNMAP_B_</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>

  <span class="kt">wire</span> <span class="n">_TECHMAP_FAIL_</span> <span class="o">=</span> <span class="n">A_WIDTH</span> <span class="o">!=</span> <span class="n">B_WIDTH</span> <span class="o">||</span> <span class="n">B_WIDTH</span> <span class="o">&lt;</span> <span class="n">Y_WIDTH</span> <span class="o">||</span>
                        <span class="n">_TECHMAP_CONNMAP_A_</span> <span class="o">!=</span> <span class="n">_TECHMAP_CONNMAP_B_</span><span class="p">;</span>

  <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">&lt;&lt;</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">X</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">A</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog addshift_test.v
hierarchy -check -top test

techmap -map addshift_map.v;;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="notes-on-using-techmap">
<h4>Notes on using techmap<a class="headerlink" href="#notes-on-using-techmap" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul>
<li><p>Don’t use positional cell parameters in map modules.</p></li>
<li><div class="line-block">
<div class="line">Don’t try to implement basic logic optimization with techmap.</div>
<div class="line">(So the OR-reduce using OR3X1 cells map was actually a bad
example.)</div>
</div>
</li>
<li><p>You can use the <code class="docutils literal notranslate"><span class="pre">$_ _</span></code>-prefix for internal cell types to avoid
collisions with the user-namespace. But always use two underscores
or the internal consistency checker will trigger on this cells.</p></li>
<li><p>Techmap has two major use cases:</p>
<ul>
<li><div class="line-block">
<div class="line">Creating good logic-level representation of arithmetic
functions.</div>
<div class="line">This also means using dedicated hardware resources such as
half- and full-adder cells in ASICS or dedicated carry logic
in FPGAs.</div>
</div>
</li>
<li><p>Mapping of coarse-grain resources such as block memory or DSP
cells.</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="coarse-grain-synthesis">
<h3>Coarse-grain synthesis<a class="headerlink" href="#coarse-grain-synthesis" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="centering docutils container">
<p>of   1em</p>
<div class="beamercolorbox docutils container">
<p>graybox</p>
</div>
</div>
</div>
<div class="section" id="intro-to-coarse-grain-synthesis">
<h4>Intro to coarse-grain synthesis<a class="headerlink" href="#intro-to-coarse-grain-synthesis" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>In coarse-grain synthesis the target architecture has cells of the
same complexity or larger complexity than the internal RTL
representation.</p>
<p>For example:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="kt">wire</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
  <span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">c</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
</pre></div>
</div>
<p>This circuit contains two cells in the RTL representation: one
multiplier and one adder. In some architectures this circuit can be
implemented using a single circuit element, for example an FPGA DSP
core. Coarse grain synthesis is this mapping of groups of circuit
elements to larger components.</p>
<p>Fine-grain synthesis would be matching the circuit elements to
smaller components, such as LUTs, gates, or half- and full-adders.</p>
</div>
</div>
<div class="section" id="the-extract-pass">
<h4>The extract pass<a class="headerlink" href="#the-extract-pass" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<ul class="simple">
<li><p>Like the <code class="docutils literal notranslate"><span class="pre">techmap</span></code> pass, the <code class="docutils literal notranslate"><span class="pre">extract</span></code> pass is called with a
map file. It compares the circuits inside the modules of the map
file with the design and looks for sub-circuits in the design that
match any of the modules in the map file.</p></li>
<li><p>If a match is found, the <code class="docutils literal notranslate"><span class="pre">extract</span></code> pass will replace the
matching subcircuit with an instance of the module from the map
file.</p></li>
<li><p>In a way the <code class="docutils literal notranslate"><span class="pre">extract</span></code> pass is the inverse of the techmap pass.</p></li>
</ul>
</div>
<div class="frame docutils container">
<p>– Example 1/2 to 0cm</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">macc_16_16_32</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">c</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog macc_simple_test.v
hierarchy -check -top test

extract -map macc_simple_xmap.v;;
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– Example 2/2</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><span class="math">\downarrow</span></p></td>
<td><p><span class="math">\downarrow</span></p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td></td>
</tr>
<tr class="row-even"><td><p><span class="math">\downarrow</span></p></td>
<td><p><span class="math">\downarrow</span></p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="the-wrap-extract-unwrap-method">
<h4>The wrap-extract-unwrap method<a class="headerlink" href="#the-wrap-extract-unwrap-method" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Often a coarse-grain element has a constant bit-width, but can be
used to implement operations with a smaller bit-width. For example, a
18x25-bit multiplier can also be used to implement 16x20-bit
multiplication.</p>
<p>A way of mapping such elements in coarse grain synthesis is the
wrap-extract-unwrap method:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>wrap</strong></div>
<div class="line">Identify candidate-cells in the circuit and wrap them in a cell
with a constant wider bit-width using <code class="docutils literal notranslate"><span class="pre">techmap</span></code>. The wrappers
use the same parameters as the original cell, so the information
about the original width of the ports is preserved.</div>
<div class="line">Then use the <code class="docutils literal notranslate"><span class="pre">connwrappers</span></code> command to connect up the
bit-extended in- and outputs of the wrapper cells.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>extract</strong></div>
<div class="line">Now all operations are encoded using the same bit-width as the
coarse grain element. The <code class="docutils literal notranslate"><span class="pre">extract</span></code> command can be used to
replace circuits with cells of the target architecture.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>unwrap</strong></div>
<div class="line">The remaining wrapper cell can be unwrapped using <code class="docutils literal notranslate"><span class="pre">techmap</span></code>.</div>
</div>
</li>
</ul>
<p>The following sides detail an example that shows how to map MACC
operations of arbitrary size to MACC cells with a 18x25-bit
multiplier and a 48-bit adder (such as the Xilinx DSP48 cells).</p>
</div>
</div>
<div class="section" id="example-dsp48-macc">
<h4>Example: DSP48_MACC<a class="headerlink" href="#example-dsp48-macc" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<div class="line-block">
<div class="line">– 1/13 Preconditioning: <code class="docutils literal notranslate"><span class="pre">macc_xilinx_swap_map.v</span></code></div>
<div class="line">Make sure <code class="docutils literal notranslate"><span class="pre">A</span></code> is the smaller port on all multipliers</div>
</div>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">techmap_celltype</span> <span class="o">=</span> <span class="s">&quot;$mul&quot;</span> <span class="o">*</span><span class="p">)</span>
<span class="k">module</span> <span class="n">mul_swap_ports</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="kt">wire</span> <span class="n">_TECHMAP_FAIL_</span> <span class="o">=</span> <span class="n">A_WIDTH</span> <span class="o">&lt;=</span> <span class="n">B_WIDTH</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="n">\$mul</span> <span class="p">#(</span>
       <span class="p">.</span><span class="n">A_SIGNED</span><span class="p">(</span><span class="n">B_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_SIGNED</span><span class="p">(</span><span class="n">A_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">A_WIDTH</span><span class="p">(</span><span class="n">B_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_WIDTH</span><span class="p">(</span><span class="n">A_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y_WIDTH</span><span class="p">(</span><span class="n">Y_WIDTH</span><span class="p">)</span>
<span class="p">)</span> <span class="n">_TECHMAP_REPLACE_</span> <span class="p">(</span>
       <span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">B</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– 2/13 Wrapping multipliers: <code class="docutils literal notranslate"><span class="pre">macc_xilinx_wrap_map.v</span></code></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">techmap_celltype</span> <span class="o">=</span> <span class="s">&quot;$mul&quot;</span> <span class="o">*</span><span class="p">)</span>
<span class="k">module</span> <span class="n">mul_wrap</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">17</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A_18</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B_25</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y_48</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y_48</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">1023</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">_TECHMAP_DO_</span> <span class="o">=</span> <span class="s">&quot;proc; clean&quot;</span><span class="p">;</span>

<span class="kt">reg</span> <span class="n">_TECHMAP_FAIL_</span><span class="p">;</span>
<span class="k">initial</span> <span class="k">begin</span>
       <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span>       <span class="k">if</span> <span class="p">(</span><span class="n">A_SIGNED</span> <span class="o">||</span> <span class="n">B_SIGNED</span><span class="p">)</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">&lt;</span> <span class="mh">4</span> <span class="o">||</span> <span class="n">B_WIDTH</span> <span class="o">&lt;</span> <span class="mh">4</span><span class="p">)</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">&gt;</span> <span class="mh">18</span> <span class="o">||</span> <span class="n">B_WIDTH</span> <span class="o">&gt;</span> <span class="mh">25</span><span class="p">)</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span><span class="o">*</span><span class="n">B_WIDTH</span> <span class="o">&lt;</span> <span class="mh">100</span><span class="p">)</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">end</span>

<span class="n">\$__mul_wrapper</span> <span class="p">#(</span>
       <span class="p">.</span><span class="n">A_SIGNED</span><span class="p">(</span><span class="n">A_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_SIGNED</span><span class="p">(</span><span class="n">B_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">A_WIDTH</span><span class="p">(</span><span class="n">A_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_WIDTH</span><span class="p">(</span><span class="n">B_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y_WIDTH</span><span class="p">(</span><span class="n">Y_WIDTH</span><span class="p">)</span>
<span class="p">)</span> <span class="n">_TECHMAP_REPLACE_</span> <span class="p">(</span>
       <span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">A_18</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">B_25</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">Y_48</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– 3/13 Wrapping adders: <code class="docutils literal notranslate"><span class="pre">macc_xilinx_wrap_map.v</span></code></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">techmap_celltype</span> <span class="o">=</span> <span class="s">&quot;$add&quot;</span> <span class="o">*</span><span class="p">)</span>
<span class="k">module</span> <span class="n">add_wrap</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A_48</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B_48</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y_48</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y_48</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">1023</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">_TECHMAP_DO_</span> <span class="o">=</span> <span class="s">&quot;proc; clean&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="kt">reg</span> <span class="n">_TECHMAP_FAIL_</span><span class="p">;</span>
<span class="k">initial</span> <span class="k">begin</span>
       <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">A_SIGNED</span> <span class="o">||</span> <span class="n">B_SIGNED</span><span class="p">)</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">A_WIDTH</span> <span class="o">&lt;</span> <span class="mh">10</span> <span class="o">&amp;&amp;</span> <span class="n">B_WIDTH</span> <span class="o">&lt;</span> <span class="mh">10</span><span class="p">)</span>
               <span class="n">_TECHMAP_FAIL_</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">end</span>

<span class="n">\$__add_wrapper</span> <span class="p">#(</span>
       <span class="p">.</span><span class="n">A_SIGNED</span><span class="p">(</span><span class="n">A_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_SIGNED</span><span class="p">(</span><span class="n">B_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">A_WIDTH</span><span class="p">(</span><span class="n">A_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_WIDTH</span><span class="p">(</span><span class="n">B_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y_WIDTH</span><span class="p">(</span><span class="n">Y_WIDTH</span><span class="p">)</span>
<span class="p">)</span> <span class="n">_TECHMAP_REPLACE_</span> <span class="p">(</span>
       <span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">A_48</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">B_48</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">Y_48</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– 4/13 Extract: <code class="docutils literal notranslate"><span class="pre">macc_xilinx_xmap.v</span></code></p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">DSP48_MACC</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

<span class="k">input</span> <span class="p">[</span><span class="mh">17</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">b</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">c</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">;</span>

<span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<p>design to create a template for the <code class="docutils literal notranslate"><span class="pre">extract</span></code> command.</p>
</div>
<div class="frame docutils container">
<p>– 5/13 Unwrapping multipliers: <code class="docutils literal notranslate"><span class="pre">macc_xilinx_unwrap_map.v</span></code></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$__mul_wrapper</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="mh">17</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A_ORIG</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B_ORIG</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y_ORIG</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y_ORIG</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="n">\$mul</span> <span class="p">#(</span>
       <span class="p">.</span><span class="n">A_SIGNED</span><span class="p">(</span><span class="n">A_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_SIGNED</span><span class="p">(</span><span class="n">B_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">A_WIDTH</span><span class="p">(</span><span class="n">A_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_WIDTH</span><span class="p">(</span><span class="n">B_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y_WIDTH</span><span class="p">(</span><span class="n">Y_WIDTH</span><span class="p">)</span>
<span class="p">)</span> <span class="n">_TECHMAP_REPLACE_</span> <span class="p">(</span>
       <span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">A_ORIG</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">B_ORIG</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">Y_ORIG</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– 6/13 Unwrapping adders: <code class="docutils literal notranslate"><span class="pre">macc_xilinx_unwrap_map.v</span></code></p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$__add_wrapper</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="mh">47</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A_ORIG</span> <span class="o">=</span> <span class="n">A</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B_ORIG</span> <span class="o">=</span> <span class="n">B</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y_ORIG</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">Y_ORIG</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="n">\$add</span> <span class="p">#(</span>
       <span class="p">.</span><span class="n">A_SIGNED</span><span class="p">(</span><span class="n">A_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_SIGNED</span><span class="p">(</span><span class="n">B_SIGNED</span><span class="p">),</span>
       <span class="p">.</span><span class="n">A_WIDTH</span><span class="p">(</span><span class="n">A_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B_WIDTH</span><span class="p">(</span><span class="n">B_WIDTH</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y_WIDTH</span><span class="p">(</span><span class="n">Y_WIDTH</span><span class="p">)</span>
<span class="p">)</span> <span class="n">_TECHMAP_REPLACE_</span> <span class="p">(</span>
       <span class="p">.</span><span class="n">A</span><span class="p">(</span><span class="n">A_ORIG</span><span class="p">),</span>
       <span class="p">.</span><span class="n">B</span><span class="p">(</span><span class="n">B_ORIG</span><span class="p">),</span>
       <span class="p">.</span><span class="n">Y</span><span class="p">(</span><span class="n">Y_ORIG</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>– 7/13</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">test1</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">test2</span></code></p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><span class="math">\downarrow</span></p></td>
<td><p><span class="math">\downarrow</span></p></td>
</tr>
</tbody>
</table>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog macc_xilinx_test.v
                            hierarchy -check
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><span class="math">\downarrow</span></p></td>
<td><p><span class="math">\downarrow</span></p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="frame docutils container">
<p>– 8/13</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">test1</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">test2</span></code></p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p><span class="math">\downarrow</span></p></td>
<td><p><span class="math">\downarrow</span></p></td>
</tr>
</tbody>
</table>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>techmap -map macc_xilinx_swap_map.v ;;
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><span class="math">\downarrow</span></p></td>
<td><p><span class="math">\downarrow</span></p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="frame docutils container">
<p>– 9/13 Wrapping in <code class="docutils literal notranslate"><span class="pre">test1</span></code>:</p>
<div class="columns docutils container">
<p>to 0cm</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>techmap -map macc_xilinx_wrap_map.v

connwrappers -unsigned $__mul_wrapper \
                            Y Y_WIDTH \
             -unsigned $__add_wrapper \
                            Y Y_WIDTH ;;
</pre></div>
</div>
</div>
<img alt="image" src="PRESENTATION_ExAdv/macc_xilinx_test1c.pdf" />
</div>
<div class="frame docutils container">
<p>– 10/13 Wrapping in <code class="docutils literal notranslate"><span class="pre">test2</span></code>:</p>
<div class="columns docutils container">
<p>to 0cm</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>techmap -map macc_xilinx_wrap_map.v

connwrappers -unsigned $__mul_wrapper \
                            Y Y_WIDTH \
             -unsigned $__add_wrapper \
                            Y Y_WIDTH ;;
</pre></div>
</div>
</div>
<img alt="image" src="PRESENTATION_ExAdv/macc_xilinx_test2c.pdf" />
</div>
<div class="frame docutils container">
<p>– 11/13 Extract in <code class="docutils literal notranslate"><span class="pre">test1</span></code>:</p>
<div class="columns docutils container">
<p>to 0cm</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>design -push
read_verilog macc_xilinx_xmap.v
techmap -map macc_xilinx_swap_map.v
techmap -map macc_xilinx_wrap_map.v;;
design -save __macc_xilinx_xmap
design -pop
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>extract -constports -ignore_parameters \
        -map %__macc_xilinx_xmap       \
        -swap $__add_wrapper A,B ;;
</pre></div>
</div>
<p>to 0cm</p>
</div>
<a class="reference internal image-reference" href="PRESENTATION_ExAdv/macc_xilinx_test1d.pdf"><img alt="image" src="PRESENTATION_ExAdv/macc_xilinx_test1d.pdf" style="width: 11cm;" /></a>
</div>
<div class="frame docutils container">
<p>– 12/13 Extract in <code class="docutils literal notranslate"><span class="pre">test2</span></code>:</p>
<div class="columns docutils container">
<p>to 0cm</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>design -push
read_verilog macc_xilinx_xmap.v
techmap -map macc_xilinx_swap_map.v
techmap -map macc_xilinx_wrap_map.v;;
design -save __macc_xilinx_xmap
design -pop
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>extract -constports -ignore_parameters \
        -map %__macc_xilinx_xmap       \
        -swap $__add_wrapper A,B ;;
</pre></div>
</div>
<p>to 0cm</p>
</div>
<a class="reference internal image-reference" href="PRESENTATION_ExAdv/macc_xilinx_test2d.pdf"><img alt="image" src="PRESENTATION_ExAdv/macc_xilinx_test2d.pdf" style="width: 11cm;" /></a>
</div>
<div class="frame docutils container">
<p>– 13/13 Unwrap in <code class="docutils literal notranslate"><span class="pre">test2</span></code>:</p>
</div>
</div>
</div>
<div class="section" id="automatic-design-changes">
<h3>Automatic design changes<a class="headerlink" href="#automatic-design-changes" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="centering docutils container">
<p>of   1em</p>
<div class="beamercolorbox docutils container">
<p>graybox</p>
</div>
</div>
</div>
<div class="section" id="changing-the-design-from-yosys">
<h4>Changing the design from Yosys<a class="headerlink" href="#changing-the-design-from-yosys" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Yosys commands can be used to change the design in memory. Examples
of this are:</p>
<ul>
<li><div class="line-block">
<div class="line"><strong>Changes in design hierarchy</strong></div>
<div class="line">Commands such as <code class="docutils literal notranslate"><span class="pre">flatten</span></code> and <code class="docutils literal notranslate"><span class="pre">submod</span></code> can be used to
change the design hierarchy, i.e. flatten the hierarchy or
moving parts of a module to a submodule. This has applications
in synthesis scripts as well as in reverse engineering and
analysis.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><strong>Behavioral changes</strong></div>
<div class="line">Commands such as <code class="docutils literal notranslate"><span class="pre">techmap</span></code> can be used to make behavioral
changes to the design, for example changing asynchronous resets
to synchronous resets. This has applications in design space
exploration (evaluation of various architectures for one
circuit).</div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="example-async-reset-to-sync-reset">
<h4>Example: Async reset to sync reset<a class="headerlink" href="#example-async-reset-to-sync-reset" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>The following techmap map file replaces all positive-edge async reset
flip-flops with positive-edge sync reset flip-flops. The code is
taken from the example Yosys script for ASIC synthesis of the Amber
ARMv2 CPU.</p>
<div class="columns docutils container">
<p>to 0cm</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">*</span> <span class="n">techmap_celltype</span> <span class="o">=</span> <span class="s">&quot;$adff&quot;</span> <span class="o">*</span><span class="p">)</span>
<span class="k">module</span> <span class="n">adff2dff</span> <span class="p">(</span><span class="n">CLK</span><span class="p">,</span> <span class="n">ARST</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Q</span><span class="p">);</span>

    <span class="k">parameter</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">CLK_POLARITY</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">ARST_POLARITY</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">parameter</span> <span class="n">ARST_VALUE</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>

    <span class="k">input</span> <span class="n">CLK</span><span class="p">,</span> <span class="n">ARST</span><span class="p">;</span>
    <span class="k">input</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">D</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="n">WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Q</span><span class="p">;</span>

    <span class="kt">wire</span> <span class="p">[</span><span class="mh">1023</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">_TECHMAP_DO_</span> <span class="o">=</span> <span class="s">&quot;proc&quot;</span><span class="p">;</span>

    <span class="kt">wire</span> <span class="n">_TECHMAP_FAIL_</span> <span class="o">=</span> <span class="o">!</span><span class="n">CLK_POLARITY</span> <span class="o">||</span> <span class="o">!</span><span class="n">ARST_POLARITY</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// ..continued..</span>


    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">CLK</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ARST</span><span class="p">)</span>
            <span class="n">Q</span> <span class="o">&lt;=</span> <span class="n">ARST_VALUE</span><span class="p">;</span>
        <span class="k">else</span>
             <span class="o">&lt;=</span> <span class="n">D</span><span class="p">;</span>

<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="summary-2">
<span id="id6"></span><h3>Summary<a class="headerlink" href="#summary-2" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>A lot can be achieved in Yosys just with the standard set of
commands.</p></li>
<li><p>The commands <code class="docutils literal notranslate"><span class="pre">techmap</span></code> and <code class="docutils literal notranslate"><span class="pre">extract</span></code> can be used to prototype
many complex synthesis tasks.</p></li>
</ul>
<div class="center docutils container">
<p>Questions?</p>
</div>
<div class="center docutils container">
<p><a class="reference external" href="http://www.clifford.at/yosys/">http://www.clifford.at/yosys/</a></p>
</div>
</div>
</div>
</div>
<div class="section" id="yosys-by-example-beyond-synthesis">
<h2>Yosys by example – Beyond Synthesis<a class="headerlink" href="#yosys-by-example-beyond-synthesis" title="Permalink to this headline">¶</a></h2>
<div class="frame docutils container">
<p>Overview This section contains 2 subsections:</p>
<ul class="simple">
<li><p>Interactive Design Investigation</p></li>
<li><p>Symbolic Model Checking</p></li>
</ul>
</div>
<div class="section" id="interactive-design-investigation">
<h3>Interactive Design Investigation<a class="headerlink" href="#interactive-design-investigation" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="centering docutils container">
<p>of   1em</p>
<div class="beamercolorbox docutils container">
<p>graybox</p>
</div>
</div>
</div>
<div class="frame docutils container">
<p>Yosys can also be used to investigate designs (or netlists created
from other tools).</p>
<ul class="simple">
<li><p>The selection mechanism (see slides “Using Selections”),
especially patterns such as <code class="docutils literal notranslate"><span class="pre">%ci</span></code> and <code class="docutils literal notranslate"><span class="pre">%co</span></code>, can be used to
figure out how parts of the design are connected.</p></li>
<li><p>Commands such as <code class="docutils literal notranslate"><span class="pre">submod</span></code>, <code class="docutils literal notranslate"><span class="pre">expose</span></code>, <code class="docutils literal notranslate"><span class="pre">splice</span></code>, …can be used
to transform the design into an equivalent design that is easier
to analyse.</p></li>
<li><p>Commands such as <code class="docutils literal notranslate"><span class="pre">eval</span></code> and <code class="docutils literal notranslate"><span class="pre">sat</span></code> can be used to investigate
the behavior of the circuit.</p></li>
</ul>
</div>
<div class="frame docutils container">
<p>Example: Reorganizing a module</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">scrambler</span><span class="p">(</span>
        <span class="k">input</span> <span class="n">clk</span><span class="p">,</span> <span class="n">rst</span><span class="p">,</span> <span class="n">in_bit</span><span class="p">,</span>
        <span class="k">output</span> <span class="kt">reg</span> <span class="n">out_bit</span>
<span class="p">);</span>
    <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">xs</span><span class="p">;</span>
    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">rst</span><span class="p">)</span>
           <span class="n">xs</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span> <span class="o">^</span> <span class="p">(</span><span class="n">xs</span> <span class="o">&lt;&lt;</span> <span class="mh">13</span><span class="p">);</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span> <span class="o">^</span> <span class="p">(</span><span class="n">xs</span> <span class="o">&gt;&gt;</span> <span class="mh">17</span><span class="p">);</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xs</span> <span class="o">^</span> <span class="p">(</span><span class="n">xs</span> <span class="o">&lt;&lt;</span> <span class="mh">5</span><span class="p">);</span>
        <span class="n">out_bit</span> <span class="o">&lt;=</span> <span class="n">in_bit</span> <span class="o">^</span> <span class="n">xs</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog scrambler.v

hierarchy; proc;;

cd scrambler
submod -name xorshift32 \
           xs %c %ci %D %c %ci:+[D] %D \
           %ci*:-$dff xs %co %ci %d
</pre></div>
</div>
</div>
<a class="reference internal image-reference" href="PRESENTATION_ExOth/scrambler_p01.pdf"><img alt="image" src="PRESENTATION_ExOth/scrambler_p01.pdf" style="width: 11cm;" /></a>
<a class="reference internal image-reference" href="PRESENTATION_ExOth/scrambler_p02.pdf"><img alt="image" src="PRESENTATION_ExOth/scrambler_p02.pdf" style="width: 11cm;" /></a>
</div>
<div class="frame docutils container">
<p>Example: Analysis of circuit behavior</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>&gt; read_verilog scrambler.v
&gt; hierarchy; proc;; cd scrambler
&gt; submod -name xorshift32 xs %c %ci %D %c %ci:+[D] %D %ci*:-$dff xs %co %ci %d

&gt; cd xorshift32
&gt; rename n2 in
&gt; rename n1 out

&gt; eval -set in 1 -show out
Eval result: \out = 270369.

&gt; eval -set in 270369 -show out
Eval result: \out = 67634689.

&gt; sat -set out 632435482
Signal Name                 Dec        Hex                                   Bin
<span class="gd">-------------------- ---------- ---------- -------------------------------------</span>
\in                   745495504   2c6f5bd0      00101100011011110101101111010000
\out                  632435482   25b2331a      00100101101100100011001100011010
</pre></div>
</div>
</div>
</div>
<div class="section" id="symbolic-model-checking">
<h3>Symbolic Model Checking<a class="headerlink" href="#symbolic-model-checking" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<div class="centering docutils container">
<p>of   1em</p>
<div class="beamercolorbox docutils container">
<p>graybox</p>
</div>
</div>
</div>
<div class="frame docutils container">
<p>Symbolic Model Checking (SMC) is used to formally prove that a
circuit has (or has not) a given property.</p>
<p>One application is Formal Equivalence Checking: Proving that two
circuits are identical. For example this is a very useful feature
when debugging custom passes in Yosys.</p>
<p>Other applications include checking if a module conforms to interface
standards.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sat</span></code> command in Yosys can be used to perform Symbolic Model
Checking.</p>
</div>
<div class="frame docutils container">
<p>Example: Formal Equivalence Checking (1/2) Remember the following
example? 1em</p>
<p>to 0cm</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">\$add</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">Y</span><span class="p">);</span>

<span class="k">parameter</span> <span class="n">A_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_SIGNED</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">A_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">B_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">parameter</span> <span class="n">Y_WIDTH</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>

<span class="k">input</span> <span class="p">[</span><span class="n">A_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">A</span><span class="p">;</span>
<span class="k">input</span> <span class="p">[</span><span class="n">B_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">B</span><span class="p">;</span>
<span class="k">output</span> <span class="p">[</span><span class="n">Y_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">Y</span><span class="p">;</span>

<span class="k">generate</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">A_WIDTH</span> <span class="o">==</span> <span class="mh">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">B_WIDTH</span> <span class="o">==</span> <span class="mh">32</span><span class="p">))</span>
    <span class="k">begin</span>
      <span class="kt">wire</span> <span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">S1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
      <span class="kt">wire</span> <span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">S2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]</span> <span class="o">+</span> <span class="n">S1</span><span class="p">[</span><span class="mh">16</span><span class="p">];</span>
      <span class="k">assign</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">{</span><span class="n">S2</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span> <span class="n">S1</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="kt">wire</span> <span class="n">_TECHMAP_FAIL_</span> <span class="o">=</span> <span class="mh">1</span><span class="p">;</span>
<span class="k">endgenerate</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<p>to 0cm</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
            <span class="k">output</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">);</span>
<span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog techmap_01.v
hierarchy -check -top test
techmap -map techmap_01_map.v;;
</pre></div>
</div>
<p>Lets see if it is correct..</p>
</div>
<div class="frame docutils container">
<p>Example: Formal Equivalence Checking (2/2)</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span># read test design
read_verilog techmap_01.v
hierarchy -top test

# create two version of the design: test_orig and test_mapped
copy test test_orig
rename test test_mapped

# apply the techmap only to test_mapped
techmap -map techmap_01_map.v test_mapped

# create a miter circuit to test equivalence
miter -equiv -make_assert -make_outputs test_orig test_mapped miter
flatten miter

# run equivalence check
sat -verify -prove-asserts -show-inputs -show-outputs miter
</pre></div>
</div>
<p>…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Solving problem with 945 variables and 2505 clauses..
SAT proof finished - no model found: SUCCESS!
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>Example: Symbolic Model Checking (1/2) The following AXI4 Stream
Master has a bug. But the bug is not exposed if the slave keeps
<code class="docutils literal notranslate"><span class="pre">tready</span></code> asserted all the time. (Something a test bench might do.)</p>
<p>Symbolic Model Checking can be used to expose the bug and find a
sequence of values for <code class="docutils literal notranslate"><span class="pre">tready</span></code> that yield the incorrect behavior.</p>
<p>-1em</p>
<div class="columns docutils container">
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">axis_master</span><span class="p">(</span><span class="n">aclk</span><span class="p">,</span> <span class="n">aresetn</span><span class="p">,</span> <span class="n">tvalid</span><span class="p">,</span> <span class="n">tready</span><span class="p">,</span> <span class="n">tdata</span><span class="p">);</span>
    <span class="k">input</span> <span class="n">aclk</span><span class="p">,</span> <span class="n">aresetn</span><span class="p">,</span> <span class="n">tready</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="n">tvalid</span><span class="p">;</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">tdata</span><span class="p">;</span>

    <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">state</span><span class="p">;</span>
    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">aclk</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aresetn</span><span class="p">)</span> <span class="k">begin</span>
           <span class="n">state</span> <span class="o">&lt;=</span> <span class="mh">314159265</span><span class="p">;</span>
           <span class="n">tvalid</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
           <span class="n">tdata</span> <span class="o">&lt;=</span> <span class="p">&#39;</span><span class="n">bx</span><span class="p">;</span>
       <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">tvalid</span> <span class="o">&amp;&amp;</span> <span class="n">tready</span><span class="p">)</span>
               <span class="n">tvalid</span> <span class="o">&lt;=</span> <span class="mh">0</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tvalid</span> <span class="o">||</span> <span class="o">!</span><span class="n">tready</span><span class="p">)</span> <span class="k">begin</span>
           <span class="c1">//             ^- should not be inverted!</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">^</span> <span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="mh">13</span><span class="p">;</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">^</span> <span class="n">state</span> <span class="o">&gt;&gt;</span> <span class="mh">7</span><span class="p">;</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">state</span> <span class="o">^</span> <span class="n">state</span> <span class="o">&lt;&lt;</span> <span class="mh">17</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mh">9</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0</span><span class="p">)</span> <span class="k">begin</span>
                   <span class="n">tvalid</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
                   <span class="n">tdata</span> <span class="o">&lt;=</span> <span class="n">state</span><span class="p">;</span>
               <span class="k">end</span>
           <span class="k">end</span>
       <span class="k">end</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">axis_test</span><span class="p">(</span><span class="n">aclk</span><span class="p">,</span> <span class="n">tready</span><span class="p">);</span>
    <span class="k">input</span> <span class="n">aclk</span><span class="p">,</span> <span class="n">tready</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="n">aresetn</span><span class="p">,</span> <span class="n">tvalid</span><span class="p">;</span>
    <span class="kt">wire</span> <span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">tdata</span><span class="p">;</span>

    <span class="k">integer</span> <span class="n">counter</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>
    <span class="kt">reg</span> <span class="n">aresetn</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span>

    <span class="n">axis_master</span> <span class="n">uut</span> <span class="p">(</span><span class="n">aclk</span><span class="p">,</span> <span class="n">aresetn</span><span class="p">,</span> <span class="n">tvalid</span><span class="p">,</span> <span class="n">tready</span><span class="p">,</span> <span class="n">tdata</span><span class="p">);</span>

    <span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">aclk</span><span class="p">)</span> <span class="k">begin</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">aresetn</span> <span class="o">&amp;&amp;</span> <span class="n">tready</span> <span class="o">&amp;&amp;</span> <span class="n">tvalid</span><span class="p">)</span> <span class="k">begin</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">0</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span>  <span class="mh">19</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">1</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span>  <span class="mh">99</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">2</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span>   <span class="mh">1</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">3</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="mh">244</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">4</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="mh">133</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">5</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="mh">209</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">6</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="mh">241</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">7</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="mh">137</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">8</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span> <span class="mh">176</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mh">9</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">tdata</span> <span class="o">==</span>   <span class="mh">6</span><span class="p">);</span>
           <span class="n">counter</span> <span class="o">&lt;=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mh">1</span><span class="p">;</span>
       <span class="k">end</span>
       <span class="n">aresetn</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">endmodule</span>
</pre></div>
</div>
</div>
</div>
<div class="frame docutils container">
<p>Example: Symbolic Model Checking (2/2)</p>
<div class="highlight-ys notranslate"><div class="highlight"><pre><span></span>read_verilog -sv axis_master.v axis_test.v
hierarchy -top axis_test

proc; flatten;;
sat -seq 50 -prove-asserts
</pre></div>
</div>
<p>…with unmodified <code class="docutils literal notranslate"><span class="pre">axis_master.v</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Solving problem with 159344 variables and 442126 clauses..
SAT proof finished - model found: FAIL!
</pre></div>
</div>
<p>…with fixed <code class="docutils literal notranslate"><span class="pre">axis_master.v</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Solving problem with 159144 variables and 441626 clauses..
SAT proof finished - no model found: SUCCESS!
</pre></div>
</div>
</div>
</div>
<div class="section" id="summary-3">
<span id="id7"></span><h3>Summary<a class="headerlink" href="#summary-3" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Yosys provides useful features beyond synthesis.</p></li>
<li><p>The commands <code class="docutils literal notranslate"><span class="pre">sat</span></code> and <code class="docutils literal notranslate"><span class="pre">eval</span></code> can be used to analyse the
behavior of a circuit.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">sat</span></code> command can also be used for symbolic model checking.</p></li>
<li><p>This can be useful for debugging and testing designs and Yosys
extensions alike.</p></li>
</ul>
<div class="center docutils container">
<p>Questions?</p>
</div>
<div class="center docutils container">
<p><a class="reference external" href="http://www.clifford.at/yosys/">http://www.clifford.at/yosys/</a></p>
</div>
</div>
</div>
</div>
<div class="section" id="writing-yosys-extensions-in-c">
<h2>Writing Yosys extensions in C++<a class="headerlink" href="#writing-yosys-extensions-in-c" title="Permalink to this headline">¶</a></h2>
<div class="section" id="program-components-and-data-formats-1">
<span id="id8"></span><h3>Program Components and Data Formats<a class="headerlink" href="#program-components-and-data-formats-1" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
</div>
</div>
<div class="section" id="simplified-rtlil-entity-relationship-diagram">
<h3>Simplified RTLIL Entity-Relationship Diagram<a class="headerlink" href="#simplified-rtlil-entity-relationship-diagram" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Between passses and frontends/backends the design is stored in Yosys’
internal RTLIL (RTL Intermediate Language) format. For writing Yosys
extensions it is key to understand this format.</p>
</div>
</div>
<div class="section" id="rtlil-without-memories-and-processes">
<h3>RTLIL without memories and processes<a class="headerlink" href="#rtlil-without-memories-and-processes" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>After the commands <code class="docutils literal notranslate"><span class="pre">proc</span></code> and <code class="docutils literal notranslate"><span class="pre">memory</span></code> (or <code class="docutils literal notranslate"><span class="pre">memory</span> <span class="pre">-nomap</span></code>), we
are left with a much simpler version of RTLIL:</p>
<p>Many commands simply choose to only work on this simpler version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">RTLIL</span><span class="p">::</span><span class="n">Module</span> <span class="o">*</span><span class="n">module</span> <span class="p">:</span> <span class="n">design</span><span class="o">-&gt;</span><span class="n">selected_modules</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">has_memories_warn</span><span class="p">()</span> <span class="o">||</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">has_processes_warn</span><span class="p">())</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="o">....</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For simplicity we only discuss this version of RTLIL in this
presentation.</p>
</div>
</div>
<div class="section" id="using-dump-and-show-commands">
<h3>Using dump and show commands<a class="headerlink" href="#using-dump-and-show-commands" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">dump</span></code> command prints the design (or parts of it) in the
text representation of RTLIL.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">show</span></code> command visualizes how the components in the design
are connected.</p></li>
</ul>
<p>When trying to understand what a command does, create a small test
case and look at the output of <code class="docutils literal notranslate"><span class="pre">dump</span></code> and <code class="docutils literal notranslate"><span class="pre">show</span></code> before and after
the command has been executed.</p>
</div>
</div>
<div class="section" id="the-rtlil-data-structures">
<h3>The RTLIL Data Structures<a class="headerlink" href="#the-rtlil-data-structures" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The RTLIL data structures are simple structs utilizing <code class="docutils literal notranslate"><span class="pre">pool&lt;&gt;</span></code> and
<code class="docutils literal notranslate"><span class="pre">dict&lt;&gt;</span></code> containers (drop-in replacements for
<code class="docutils literal notranslate"><span class="pre">std::unordered_set&lt;&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">std::unordered_map&lt;&gt;</span></code>).</p>
<ul class="simple">
<li><p>Most operations are performed directly on the RTLIL structs
without setter or getter functions.</p></li>
<li><p>In debug builds a consistency checker is run over the in-memory
design between commands to make sure that the RTLIL representation
is intact.</p></li>
<li><p>Most RTLIL structs have helper methods that perform the most
common operations.</p></li>
</ul>
<p>See <code class="docutils literal notranslate"><span class="pre">yosys/kernel/rtlil.h</span></code> for details.</p>
</div>
<div class="section" id="rtlil-idstring">
<h4>RTLIL::IdString<a class="headerlink" href="#rtlil-idstring" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p><code class="docutils literal notranslate"><span class="pre">RTLIL::IdString</span></code> in many ways behave like a <code class="docutils literal notranslate"><span class="pre">std::string</span></code>. It is
used for names of RTLIL objects. Internally a RTLIL::IdString object
is only a single integer.</p>
<p>The first character of a <code class="docutils literal notranslate"><span class="pre">RTLIL::IdString</span></code> specifies if the name is
<em>public</em> or <em>private</em>:</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RTLIL::IdString[0]</span> <span class="pre">==</span> <span class="pre">’\\’</span></code>:</div>
<div class="line">This is a public name. Usually this means it is a name that was
declared in a Verilog file.</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">RTLIL::IdString[0]</span> <span class="pre">==</span> <span class="pre">’$’</span></code>:</div>
<div class="line">This is a private name. It was assigned by Yosys.</div>
</div>
</li>
</ul>
<p>Use the <code class="docutils literal notranslate"><span class="pre">NEW_ID</span></code> macro to create a new unique private name.</p>
</div>
</div>
<div class="section" id="rtlil-design-and-rtlil-module">
<h4>RTLIL::Design and RTLIL::Module<a class="headerlink" href="#rtlil-design-and-rtlil-module" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">RTLIL::Design</span></code> and <code class="docutils literal notranslate"><span class="pre">RTLIL::Module</span></code> structs are the top-level
RTLIL data structures. Yosys always operates on one active design,
but can hold many designs in memory.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">Design</span> <span class="p">{</span>
    <span class="n">dict</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">Module</span><span class="o">*&gt;</span> <span class="n">modules_</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
    <span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">dict</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">Wire</span><span class="o">*&gt;</span> <span class="n">wires_</span><span class="p">;</span>
    <span class="n">dict</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">Cell</span><span class="o">*&gt;</span> <span class="n">cells_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSig</span><span class="o">&gt;</span> <span class="n">connections_</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>(Use the various accessor functions instead of directly working with
the <code class="docutils literal notranslate"><span class="pre">_</span></code> members.)</p>
</div>
</div>
<div class="section" id="the-rtlil-wire-structure">
<h4>The RTLIL::Wire Structure<a class="headerlink" href="#the-rtlil-wire-structure" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Each wire in the design is represented by a <code class="docutils literal notranslate"><span class="pre">RTLIL::Wire</span></code> struct:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">Wire</span> <span class="p">{</span>
    <span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span> <span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">start_offset</span><span class="p">,</span> <span class="n">port_id</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">port_input</span><span class="p">,</span> <span class="n">port_output</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 75%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">width</span></code></p></td>
<td><p>The total number of bits. E.g. 10 for <code class="docutils literal notranslate"><span class="pre">[9:0]</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">start_offset</span></code></p></td>
<td><p>The lowest bit index. E.g. 3 for <code class="docutils literal notranslate"><span class="pre">[5:3]</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">port_id</span></code></p></td>
<td><p>Zero for non-ports. Positive index for ports.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">port_input</span></code></p></td>
<td><p>True for <code class="docutils literal notranslate"><span class="pre">input</span></code> and <code class="docutils literal notranslate"><span class="pre">inout</span></code> ports.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">port_output</span></code></p></td>
<td><p>True for <code class="docutils literal notranslate"><span class="pre">output</span></code> and <code class="docutils literal notranslate"><span class="pre">inout</span></code> ports.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="rtlil-state-and-rtlil-const">
<h4>RTLIL::State and RTLIL::Const<a class="headerlink" href="#rtlil-state-and-rtlil-const" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">RTLIL::State</span></code> enum represents a simple 1-bit logic level:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">State</span> <span class="p">{</span>
    <span class="n">S0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">S1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">Sx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">// undefined value or conflict</span>
    <span class="n">Sz</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="c1">// high-impedance / not-connected</span>
    <span class="n">Sa</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="c1">// don&#39;t care (used only in cases)</span>
    <span class="n">Sm</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1">// marker (used internally by some passes)</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">RTLIL::Const</span></code> struct represents a constant multi-bit value:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">Const</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">State</span><span class="o">&gt;</span> <span class="n">bits</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Notice that Yosys is not using special <code class="docutils literal notranslate"><span class="pre">VCC</span></code> or <code class="docutils literal notranslate"><span class="pre">GND</span></code> driver
cells to represent constants. Instead constants are part of the RTLIL
representation itself.</p>
</div>
</div>
<div class="section" id="the-rtlil-sigspec-structure">
<h4>The RTLIL::SigSpec Structure<a class="headerlink" href="#the-rtlil-sigspec-structure" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">RTLIL::SigSpec</span></code> struct represents a signal vector. Each bit
can either be a bit from a wire or a constant value.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">SigBit</span>
<span class="p">{</span>
    <span class="n">RTLIL</span><span class="o">::</span><span class="n">Wire</span> <span class="o">*</span><span class="n">wire</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="n">RTLIL</span><span class="o">::</span><span class="n">State</span> <span class="n">data</span><span class="p">;</span> <span class="c1">// used if wire == NULL</span>
        <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>        <span class="c1">// used if wire != NULL</span>
    <span class="p">};</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">SigBit</span><span class="o">&gt;</span> <span class="n">bits_</span><span class="p">;</span> <span class="c1">// LSB at index 0</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">RTLIL::SigSpec</span></code> struct has a ton of additional helper methods
to compare, analyze, and manipulate instances of <code class="docutils literal notranslate"><span class="pre">RTLIL::SigSpec</span></code>.</p>
</div>
</div>
<div class="section" id="the-rtlil-cell-structure">
<h4>The RTLIL::Cell Structure<a class="headerlink" href="#the-rtlil-cell-structure" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>(1/2) The <code class="docutils literal notranslate"><span class="pre">RTLIL::Cell</span></code> struct represents an instance of a module
or library cell.</p>
<p>The ports of the cell are associated with <code class="docutils literal notranslate"><span class="pre">RTLIL::SigSpec</span></code>
instances and the parameters are associated with <code class="docutils literal notranslate"><span class="pre">RTLIL::Const</span></code>
instances:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">Cell</span> <span class="p">{</span>
    <span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">dict</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span><span class="o">&gt;</span> <span class="n">connections_</span><span class="p">;</span>
    <span class="n">dict</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">IdString</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">Const</span><span class="o">&gt;</span> <span class="n">parameters</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">type</span></code> may refer to another module in the same design, a cell
name from a cell library, or a cell name from the internal cell
library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$not $pos $neg $and $or $xor $xnor $reduce_and $reduce_or $reduce_xor $reduce_xnor
$reduce_bool $shl $shr $sshl $sshr $lt $le $eq $ne $eqx $nex $ge $gt $add $sub $mul $div $mod
$divfloor $modfloor $pow $logic_not $logic_and $logic_or $mux $pmux $slice $concat $lut $assert $sr $dff
$dffsr $adff $dlatch $dlatchsr $memrd $memwr $mem $fsm $_NOT_ $_AND_ $_OR_ $_XOR_ $_MUX_ $_SR_NN_
$_SR_NP_ $_SR_PN_ $_SR_PP_ $_DFF_N_ $_DFF_P_ $_DFF_NN0_ $_DFF_NN1_ $_DFF_NP0_ $_DFF_NP1_ $_DFF_PN0_
$_DFF_PN1_ $_DFF_PP0_ $_DFF_PP1_ $_DFFSR_NNN_ $_DFFSR_NNP_ $_DFFSR_NPN_ $_DFFSR_NPP_ $_DFFSR_PNN_
$_DFFSR_PNP_ $_DFFSR_PPN_ $_DFFSR_PPP_ $_DLATCH_N_ $_DLATCH_P_ $_DLATCHSR_NNN_ $_DLATCHSR_NNP_
$_DLATCHSR_NPN_ $_DLATCHSR_NPP_ $_DLATCHSR_PNN_ $_DLATCHSR_PNP_ $_DLATCHSR_PPN_ $_DLATCHSR_PPP_
</pre></div>
</div>
</div>
<div class="frame docutils container">
<p>(2/2) Simulation models (i.e. <em>documentation</em> :-) for the internal
cell library:</p>
<div class="line-block">
<div class="line">2em <code class="docutils literal notranslate"><span class="pre">yosys/techlibs/common/simlib.v</span></code> and</div>
<div class="line">2em <code class="docutils literal notranslate"><span class="pre">yosys/techlibs/common/simcells.v</span></code></div>
</div>
<p>The lower-case cell types (such as <code class="docutils literal notranslate"><span class="pre">$and</span></code>) are parameterized cells
of variable width. This so-called <em>RTL Cells</em> are the cells described
in <code class="docutils literal notranslate"><span class="pre">simlib.v</span></code>.</p>
<p>The upper-case cell types (such as <code class="docutils literal notranslate"><span class="pre">$_AND_</span></code>) are single-bit cells
that are not parameterized. This so-called <em>Internal Logic Gates</em> are
the cells described in <code class="docutils literal notranslate"><span class="pre">simcells.v</span></code>.</p>
<p>The consistency checker also checks the interfaces to the internal
cell library. If you want to use private cell types for your own
purposes, use the <code class="docutils literal notranslate"><span class="pre">$__</span></code>-prefix to avoid name collisions.</p>
</div>
</div>
<div class="section" id="connecting-wires-or-constant-drivers">
<h4>Connecting wires or constant drivers<a class="headerlink" href="#connecting-wires-or-constant-drivers" title="Permalink to this headline">¶</a></h4>
<div class="frame docutils container">
<p>Additional connections between wires or between wires and constants
are modelled using <code class="docutils literal notranslate"><span class="pre">RTLIL::Module::connections</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span><span class="o">&gt;</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSig</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">RTLIL</span><span class="o">::</span><span class="n">Module</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSig</span><span class="o">&gt;</span> <span class="n">connections_</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">RTLIL::SigSig::first</span></code> is the driven signal and
<code class="docutils literal notranslate"><span class="pre">RTLIL::SigSig::second</span></code> is the driving signal. Example usage
(setting wire <code class="docutils literal notranslate"><span class="pre">foo</span></code> to value <code class="docutils literal notranslate"><span class="pre">42</span></code>):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">module</span><span class="o">-&gt;</span><span class="n">connect</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">wire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">foo&quot;</span><span class="p">),</span>
                <span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="k">module</span><span class="o">-&gt;</span><span class="n">wire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">foo&quot;</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="creating-modules-from-scratch">
<h3>Creating modules from scratch<a class="headerlink" href="#creating-modules-from-scratch" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Let’s create the following module using the RTLIL API:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">absval</span><span class="p">(</span><span class="k">input</span> <span class="k">signed</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span> <span class="k">output</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">y</span><span class="p">);</span>
    <span class="k">assign</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span> <span class="o">?</span> <span class="o">-</span><span class="n">a</span> <span class="o">:</span> <span class="n">a</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">RTLIL</span><span class="o">::</span><span class="n">Module</span> <span class="o">*</span><span class="k">module</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">Module</span><span class="p">;</span>
<span class="k">module</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">absval&quot;</span><span class="p">;</span>

<span class="n">RTLIL</span><span class="o">::</span><span class="n">Wire</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="k">module</span><span class="o">-&gt;</span><span class="n">addWire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">a&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">a</span><span class="o">-&gt;</span><span class="n">port_input</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">a</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">RTLIL</span><span class="o">::</span><span class="n">Wire</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="k">module</span><span class="o">-&gt;</span><span class="n">addWire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">y&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">y</span><span class="o">-&gt;</span><span class="n">port_output</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">y</span><span class="o">-&gt;</span><span class="n">port_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="n">RTLIL</span><span class="o">::</span><span class="n">Wire</span> <span class="o">*</span><span class="n">a_inv</span> <span class="o">=</span> <span class="k">module</span><span class="o">-&gt;</span><span class="n">addWire</span><span class="p">(</span><span class="n">NEW_ID</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="k">module</span><span class="o">-&gt;</span><span class="n">addNeg</span><span class="p">(</span><span class="n">NEW_ID</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a_inv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="k">module</span><span class="o">-&gt;</span><span class="n">addMux</span><span class="p">(</span><span class="n">NEW_ID</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a_inv</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">y</span><span class="p">);</span>

<span class="k">module</span><span class="o">-&gt;</span><span class="n">fixup_ports</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="modifying-modules">
<h3>Modifying modules<a class="headerlink" href="#modifying-modules" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Most commands modify existing modules, not create new ones.</p>
<p>When modifying existing modules, stick to the following DOs and
DON’Ts:</p>
<ul class="simple">
<li><p>Do not remove wires. Simply disconnect them and let a successive
<code class="docutils literal notranslate"><span class="pre">clean</span></code> command worry about removing it.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">module-&gt;fixup_ports()</span></code> after changing the <code class="docutils literal notranslate"><span class="pre">port_</span></code>
properties of wires.</p></li>
<li><p>You can safely remove cells or change the <code class="docutils literal notranslate"><span class="pre">connections</span></code> property
of a cell, but be careful when changing the size of the
<code class="docutils literal notranslate"><span class="pre">SigSpec</span></code> connected to a cell port.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">SigMap</span></code> helper class (see next slide) when you need a
unique handle for each signal bit.</p></li>
</ul>
</div>
</div>
<div class="section" id="using-the-sigmap-helper-class">
<h3>Using the SigMap helper class<a class="headerlink" href="#using-the-sigmap-helper-class" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Consider the following module:</p>
<div class="highlight-verilog notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">test</span><span class="p">(</span><span class="k">input</span> <span class="n">a</span><span class="p">,</span> <span class="k">output</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
    <span class="k">assign</span> <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<p>In this case <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">x</span></code>, and <code class="docutils literal notranslate"><span class="pre">y</span></code> are all different names for the
same signal. However:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">RTLIL</span><span class="o">::</span><span class="n">SigSpec</span> <span class="n">a</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">wire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">a&quot;</span><span class="p">)),</span> <span class="n">x</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">wire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">x&quot;</span><span class="p">)),</span>
                                       <span class="n">y</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">wire</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">y&quot;</span><span class="p">));</span>
<span class="n">log</span><span class="p">(</span><span class="s">&quot;%d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">==</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">==</span> <span class="n">a</span><span class="p">);</span> <span class="c1">// will print &quot;0 0 0&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SigMap</span></code> helper class can be used to map all such aliasing
signals to a unique signal from the group (usually the wire that is
directly driven by a cell or port).</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">SigMap</span> <span class="nf">sigmap</span><span class="p">(</span><span class="k">module</span><span class="p">);</span>
<span class="n">log</span><span class="p">(</span><span class="s">&quot;%d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">sigmap</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">sigmap</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">sigmap</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
                  <span class="n">sigmap</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="n">sigmap</span><span class="p">(</span><span class="n">a</span><span class="p">));</span> <span class="c1">// will print &quot;1 1 1&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="printing-log-messages">
<h3>Printing log messages<a class="headerlink" href="#printing-log-messages" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">log()</span></code> function is a <code class="docutils literal notranslate"><span class="pre">printf()</span></code>-like function that can be
used to create log messages.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">log_signal()</span></code> to create a C-string for a SigSpec object <a class="footnote-reference brackets" href="#id15" id="id9">5</a>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Mapped signal x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_signal</span><span class="p">(</span><span class="n">sigmap</span><span class="p">(</span><span class="n">x</span><span class="p">)));</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">log_id()</span></code> to create a C-string for an <code class="docutils literal notranslate"><span class="pre">RTLIL::IdString</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">log</span><span class="p">(</span><span class="s">&quot;Name of this module: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_id</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">log_header()</span></code> and <code class="docutils literal notranslate"><span class="pre">log_push()</span></code>/<code class="docutils literal notranslate"><span class="pre">log_pop()</span></code> to structure
log messages:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">log_header</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s">&quot;Doing important stuff!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">log_push</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Log message #%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="n">log_pop</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="error-handling">
<h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Use <code class="docutils literal notranslate"><span class="pre">log_error()</span></code> to report a non-recoverable error:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">design</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">log_error</span><span class="p">(</span><span class="s">&quot;A module with the name %s already exists!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">RTLIL</span><span class="o">::</span><span class="n">id2cstr</span><span class="p">(</span><span class="k">module</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">log_cmd_error()</span></code> to report a recoverable error:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">design</span><span class="o">-&gt;</span><span class="n">selection_stack</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span>
    <span class="n">log_cmd_error</span><span class="p">(</span><span class="s">&quot;This command can&#39;t operator on an empty selection!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">log_assert()</span></code> and <code class="docutils literal notranslate"><span class="pre">log_abort()</span></code> instead of <code class="docutils literal notranslate"><span class="pre">assert()</span></code> and
<code class="docutils literal notranslate"><span class="pre">abort()</span></code>.</p>
</div>
</div>
<div class="section" id="creating-a-command">
<h3>Creating a command<a class="headerlink" href="#creating-a-command" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Simply create a global instance of a class derived from <code class="docutils literal notranslate"><span class="pre">Pass</span></code> to
create a new yosys command:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;kernel/yosys.h&quot;</span><span class="cp"></span>
<span class="n">USING_YOSYS_NAMESPACE</span>

<span class="k">struct</span> <span class="nc">MyPass</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Pass</span> <span class="p">{</span>
    <span class="n">MyPass</span><span class="p">()</span> <span class="o">:</span> <span class="n">Pass</span><span class="p">(</span><span class="s">&quot;my_cmd&quot;</span><span class="p">,</span> <span class="s">&quot;just a simple test&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">execute</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">,</span> <span class="n">RTLIL</span><span class="o">::</span><span class="n">Design</span> <span class="o">*</span><span class="n">design</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Arguments to my_cmd:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">arg</span> <span class="p">:</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&quot;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Modules in current design:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">mod</span> <span class="p">:</span> <span class="n">design</span><span class="o">-&gt;</span><span class="n">modules</span><span class="p">())</span>
            <span class="n">log</span><span class="p">(</span><span class="s">&quot;  %s (%d wires, %d cells)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">log_id</span><span class="p">(</span><span class="n">mod</span><span class="p">),</span>
                    <span class="n">GetSize</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">wires</span><span class="p">()),</span> <span class="n">GetSize</span><span class="p">(</span><span class="n">mod</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">()));</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="n">MyPass</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="creating-a-plugin">
<h3>Creating a plugin<a class="headerlink" href="#creating-a-plugin" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<p>Yosys can be extended by adding additional C++ code to the Yosys code
base, or by loading plugins into Yosys.</p>
<p>Use the following command to compile a Yosys plugin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yosys</span><span class="o">-</span><span class="n">config</span> <span class="o">--</span><span class="n">exec</span> <span class="o">--</span><span class="n">cxx</span> <span class="o">--</span><span class="n">cxxflags</span> <span class="o">--</span><span class="n">ldflags</span> \
             <span class="o">-</span><span class="n">o</span> <span class="n">my_cmd</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">shared</span> <span class="n">my_cmd</span><span class="o">.</span><span class="n">cc</span> <span class="o">--</span><span class="n">ldlibs</span>
</pre></div>
</div>
<p>Or shorter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yosys</span><span class="o">-</span><span class="n">config</span> <span class="o">--</span><span class="n">build</span> <span class="n">my_cmd</span><span class="o">.</span><span class="n">so</span> <span class="n">my_cmd</span><span class="o">.</span><span class="n">cc</span>
</pre></div>
</div>
<p>Load the plugin using the yosys <code class="docutils literal notranslate"><span class="pre">-m</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yosys</span> <span class="o">-</span><span class="n">m</span> <span class="o">./</span><span class="n">my_cmd</span><span class="o">.</span><span class="n">so</span> <span class="o">-</span><span class="n">p</span> <span class="s1">&#39;my_cmd foo bar&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="summary-4">
<span id="id10"></span><h3>Summary<a class="headerlink" href="#summary-4" title="Permalink to this headline">¶</a></h3>
<div class="frame docutils container">
<ul class="simple">
<li><p>Writing Yosys extensions is very straight-forward.</p></li>
<li><p>…and even simpler if you don’t need RTLIL::Memory or
RTLIL::Process objects.</p></li>
<li><p>Writing synthesis software? Consider learning the Yosys API and
make your work part of the Yosys framework.</p></li>
</ul>
<div class="center docutils container">
<p>Questions?</p>
</div>
<div class="center docutils container">
<p><a class="reference external" href="http://www.clifford.at/yosys/">http://www.clifford.at/yosys/</a></p>
</div>
</div>
<dl class="footnote brackets">
<dt class="label" id="id11"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><a class="reference external" href="http://www.eecs.berkeley.edu/~alanmi/abc/">http://www.eecs.berkeley.edu/~alanmi/abc/</a></p>
</dd>
<dt class="label" id="id12"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="http://opencircuitdesign.com/qflow/">http://opencircuitdesign.com/qflow/</a></p>
</dd>
<dt class="label" id="id13"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>Not limited to synthesis but also formal verification, reverse
engineering, …</p>
</dd>
<dt class="label" id="id14"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><a class="reference external" href="http://www.eecs.berkeley.edu/~alanmi/abc/">http://www.eecs.berkeley.edu/~alanmi/abc/</a></p>
</dd>
<dt class="label" id="id15"><span class="brackets"><a class="fn-backref" href="#id9">5</a></span></dt>
<dd><p>The pointer returned by <code class="docutils literal notranslate"><span class="pre">log_signal()</span></code> is automatically freed by
the log framework at a later time.</p>
</dd>
</dl>
</div>
</div>
</div>


        </div>
        <div class="side-doc-outline">
            <div class="side-doc-outline--content"> 
<div class="localtoc">
    <p class="caption">
      <span class="caption-text">Table Of Contents</span>
    </p>
    <ul>
<li><a class="reference internal" href="#">Yosys Open SYnthesis Suite</a><ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#about-me">About me</a></li>
<li><a class="reference internal" href="#outline">Outline</a></li>
<li><a class="reference internal" href="#introduction-to-yosys">Introduction to Yosys</a><ul>
<li><a class="reference internal" href="#representations-of-digital-circuits">Representations of (digital) Circuits</a></li>
<li><a class="reference internal" href="#levels-of-abstraction-for-digital-circuits">Levels of Abstraction for Digital Circuits</a></li>
<li><a class="reference internal" href="#digital-circuit-synthesis">Digital Circuit Synthesis</a></li>
<li><a class="reference internal" href="#what-yosys-can-and-cant-do">What Yosys can and can’t do</a></li>
<li><a class="reference internal" href="#yosys-data-and-control-flow">Yosys Data- and Control-Flow</a></li>
<li><a class="reference internal" href="#program-components-and-data-formats">Program Components and Data Formats</a></li>
<li><a class="reference internal" href="#example-project">Example Project</a></li>
<li><a class="reference internal" href="#running-the-synthesis-script">Running the Synthesis Script</a></li>
<li><a class="reference internal" href="#the-synth-command">The synth command</a></li>
<li><a class="reference internal" href="#yosys-commands">Yosys Commands</a></li>
<li><a class="reference internal" href="#more-verilog-examples">More Verilog Examples</a></li>
<li><a class="reference internal" href="#currently-unsupported-verilog-2005-language-features">Currently unsupported Verilog-2005 language features</a></li>
<li><a class="reference internal" href="#verification-of-yosys">Verification of Yosys</a></li>
<li><a class="reference internal" href="#benefits-of-open-source-hdl-synthesis">Benefits of Open Source HDL Synthesis</a></li>
<li><a class="reference internal" href="#typical-applications-for-yosys">Typical Applications for Yosys</a></li>
<li><a class="reference internal" href="#projects-that-i-know-of-using-yosys">Projects (that I know of) using Yosys</a></li>
<li><a class="reference internal" href="#supported-platforms">Supported Platforms</a></li>
<li><a class="reference internal" href="#other-open-source-tools">Other Open Source Tools</a></li>
<li><a class="reference internal" href="#yosys-needs-you">Yosys needs you</a></li>
<li><a class="reference internal" href="#documentation-downloads-contacts">Documentation, Downloads, Contacts</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li><a class="reference internal" href="#yosys-by-example-synthesis">Yosys by example – Synthesis</a><ul>
<li><a class="reference internal" href="#typical-phases-of-a-synthesis-flow">Typical Phases of a Synthesis Flow</a></li>
<li><a class="reference internal" href="#reading-the-design">Reading the design</a></li>
<li><a class="reference internal" href="#design-elaboration">Design elaboration</a></li>
<li><a class="reference internal" href="#the-proc-command">The <code class="docutils literal notranslate"><span class="pre">proc</span></code> command</a></li>
<li><a class="reference internal" href="#the-opt-command">The <code class="docutils literal notranslate"><span class="pre">opt</span></code> command</a></li>
<li><a class="reference internal" href="#when-to-use-opt-or-clean">When to use <code class="docutils literal notranslate"><span class="pre">opt</span></code> or <code class="docutils literal notranslate"><span class="pre">clean</span></code></a></li>
<li><a class="reference internal" href="#the-memory-command">The <code class="docutils literal notranslate"><span class="pre">memory</span></code> command</a></li>
<li><a class="reference internal" href="#the-fsm-command">The <code class="docutils literal notranslate"><span class="pre">fsm</span></code> command</a></li>
<li><a class="reference internal" href="#the-techmap-command">The <code class="docutils literal notranslate"><span class="pre">techmap</span></code> command</a></li>
<li><a class="reference internal" href="#the-abc-command">The <code class="docutils literal notranslate"><span class="pre">abc</span></code> command</a></li>
<li><a class="reference internal" href="#other-special-purpose-mapping-commands">Other special-purpose mapping commands</a></li>
<li><a class="reference internal" href="#example-synthesis-script">Example Synthesis Script</a></li>
<li><a class="reference internal" href="#summary-1">Summary</a></li>
</ul>
</li>
<li><a class="reference internal" href="#yosys-by-example-advanced-synthesis">Yosys by example – Advanced Synthesis</a><ul>
<li><a class="reference internal" href="#using-selections">Using selections</a><ul>
<li><a class="reference internal" href="#simple-selections">Simple selections</a></li>
<li><a class="reference internal" href="#selection-by-object-name">Selection by object name</a></li>
<li><a class="reference internal" href="#module-and-design-context">Module and design context</a></li>
<li><a class="reference internal" href="#selecting-by-object-property-or-type">Selecting by object property or type</a></li>
<li><a class="reference internal" href="#combining-selection">Combining selection</a></li>
<li><a class="reference internal" href="#expanding-selections">Expanding selections</a></li>
<li><a class="reference internal" href="#incremental-selection">Incremental selection</a></li>
<li><a class="reference internal" href="#creating-selection-variables">Creating selection variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#advanced-uses-of-techmap">Advanced uses of techmap</a><ul>
<li><a class="reference internal" href="#introduction-to-techmap">Introduction to techmap</a></li>
<li><a class="reference internal" href="#conditional-techmap">Conditional techmap</a></li>
<li><a class="reference internal" href="#scripting-in-map-modules">Scripting in map modules</a></li>
<li><a class="reference internal" href="#handling-constant-inputs">Handling constant inputs</a></li>
<li><a class="reference internal" href="#handling-shorted-inputs">Handling shorted inputs</a></li>
<li><a class="reference internal" href="#notes-on-using-techmap">Notes on using techmap</a></li>
</ul>
</li>
<li><a class="reference internal" href="#coarse-grain-synthesis">Coarse-grain synthesis</a><ul>
<li><a class="reference internal" href="#intro-to-coarse-grain-synthesis">Intro to coarse-grain synthesis</a></li>
<li><a class="reference internal" href="#the-extract-pass">The extract pass</a></li>
<li><a class="reference internal" href="#the-wrap-extract-unwrap-method">The wrap-extract-unwrap method</a></li>
<li><a class="reference internal" href="#example-dsp48-macc">Example: DSP48_MACC</a></li>
</ul>
</li>
<li><a class="reference internal" href="#automatic-design-changes">Automatic design changes</a><ul>
<li><a class="reference internal" href="#changing-the-design-from-yosys">Changing the design from Yosys</a></li>
<li><a class="reference internal" href="#example-async-reset-to-sync-reset">Example: Async reset to sync reset</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary-2">Summary</a></li>
</ul>
</li>
<li><a class="reference internal" href="#yosys-by-example-beyond-synthesis">Yosys by example – Beyond Synthesis</a><ul>
<li><a class="reference internal" href="#interactive-design-investigation">Interactive Design Investigation</a></li>
<li><a class="reference internal" href="#symbolic-model-checking">Symbolic Model Checking</a></li>
<li><a class="reference internal" href="#summary-3">Summary</a></li>
</ul>
</li>
<li><a class="reference internal" href="#writing-yosys-extensions-in-c">Writing Yosys extensions in C++</a><ul>
<li><a class="reference internal" href="#program-components-and-data-formats-1">Program Components and Data Formats</a></li>
<li><a class="reference internal" href="#simplified-rtlil-entity-relationship-diagram">Simplified RTLIL Entity-Relationship Diagram</a></li>
<li><a class="reference internal" href="#rtlil-without-memories-and-processes">RTLIL without memories and processes</a></li>
<li><a class="reference internal" href="#using-dump-and-show-commands">Using dump and show commands</a></li>
<li><a class="reference internal" href="#the-rtlil-data-structures">The RTLIL Data Structures</a><ul>
<li><a class="reference internal" href="#rtlil-idstring">RTLIL::IdString</a></li>
<li><a class="reference internal" href="#rtlil-design-and-rtlil-module">RTLIL::Design and RTLIL::Module</a></li>
<li><a class="reference internal" href="#the-rtlil-wire-structure">The RTLIL::Wire Structure</a></li>
<li><a class="reference internal" href="#rtlil-state-and-rtlil-const">RTLIL::State and RTLIL::Const</a></li>
<li><a class="reference internal" href="#the-rtlil-sigspec-structure">The RTLIL::SigSpec Structure</a></li>
<li><a class="reference internal" href="#the-rtlil-cell-structure">The RTLIL::Cell Structure</a></li>
<li><a class="reference internal" href="#connecting-wires-or-constant-drivers">Connecting wires or constant drivers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#creating-modules-from-scratch">Creating modules from scratch</a></li>
<li><a class="reference internal" href="#modifying-modules">Modifying modules</a></li>
<li><a class="reference internal" href="#using-the-sigmap-helper-class">Using the SigMap helper class</a></li>
<li><a class="reference internal" href="#printing-log-messages">Printing log messages</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
<li><a class="reference internal" href="#creating-a-command">Creating a command</a></li>
<li><a class="reference internal" href="#creating-a-plugin">Creating a plugin</a></li>
<li><a class="reference internal" href="#summary-4">Summary</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
            </div>
        </div>

      <div class="clearer"></div>
    </div><div class="pagenation">
</div>
        <footer class="mdl-mini-footer">
  <div class="mdl-mini-footer__left-section">
    <div class="mdl-logo">Yosys</div>
    <div>
      <ul>
        
        <li>
          <a href="https://symbiflow.github.io/" target="_blank">SymbiFlow</a>
        </li>
        <li>
          <a href="https://lists.librecores.org/listinfo/symbiflow" target="_blank">Mailing List</a>
        </li>
        <li>
          <a href="https://webchat.freenode.net/#symbiflow" target="_blank">IRC</a>
        </li>
        <li>
          <a href="https://join.slack.com/t/symbiflow/shared_invite/enQtNTkyMjcyNTkzOTY4LTU0MzhmYWNjOGMyMTkyNjA0MmEyMWM5OWY3ZDg5MWQ3ODlmOWQwZjk2YzBmMDBjMzkzMzNjYjkwYjAxZTMyNjQ"
            target="_blank">Slack</a>
        </li>

        <!-- This is to still take up space when none of the links above are shown in the footer -->
        <li style="visibility: hidden;">
          a
        </li>
      </ul>
    </div>
  </div>

  <div class="mdl-mini-footer__right-section">
    <div>&copy; Copyright 2012-2020, Claire Wolf.</div>
    <div>Generated by <a href="http://sphinx.pocoo.org/">Sphinx</a>
      3.3.1 using <a
        href="https://github.com/SymbiFlow/sphinx_symbiflow_theme">sphinx_symbiflow_theme</a>.</div>
  </div>
</footer>
        </main>
    </div>
  </body>
</html>